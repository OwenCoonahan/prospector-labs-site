<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clean Energy Manufacturing Tracker ‚Äî Prospector Labs</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&family=Geist+Mono:wght@400;500&display=swap" rel="stylesheet">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:hsl(0 0% 3.9%);--bg-card:hsl(0 0% 5.9%);--bg-muted:hsl(0 0% 9%);
  --fg:hsl(0 0% 98%);--fg-muted:hsl(0 0% 63.9%);--fg-dim:hsl(0 0% 45%);
  --border:hsl(0 0% 14.9%);--ring:hsl(0 0% 83.1%);
  --accent:hsl(142 71% 45%);--accent-fg:hsl(144 61% 20%);
  --radius:0.5rem;--font:'Geist',system-ui,sans-serif;--mono:'Geist Mono',monospace;
  --c-solar:#facc15;--c-battery:#22c55e;--c-ev:#3b82f6;--c-wind:#06b6d4;--c-semiconductor:#a855f7;--c-other:#f97316;
}
[data-theme="light"]{
  --bg:hsl(0 0% 100%);--bg-card:hsl(0 0% 98%);--bg-muted:hsl(0 0% 96.1%);
  --fg:hsl(0 0% 3.9%);--fg-muted:hsl(0 0% 45.1%);--fg-dim:hsl(0 0% 63%);
  --border:hsl(0 0% 89.8%);--ring:hsl(0 0% 14.9%);
}
html{font-family:var(--font);background:var(--bg);color:var(--fg);font-size:14px;line-height:1.5}
body{min-height:100vh}
a{color:var(--accent);text-decoration:none}
.app{display:grid;grid-template-rows:auto 1fr;height:100vh;overflow:hidden}
header{display:flex;align-items:center;justify-content:space-between;padding:0.75rem 1.25rem;border-bottom:1px solid var(--border);background:var(--bg-card)}
header h1{font-size:1.1rem;font-weight:600;letter-spacing:-0.02em}
header .subtitle{font-size:0.8rem;color:var(--fg-muted);font-family:var(--mono)}
.header-right{display:flex;align-items:center;gap:0.75rem}
.theme-toggle{background:none;border:1px solid var(--border);border-radius:var(--radius);padding:0.35rem 0.6rem;color:var(--fg);cursor:pointer;font-size:0.85rem}
.theme-toggle:hover{background:var(--bg-muted)}
.main{display:grid;grid-template-columns:340px 1fr;overflow:hidden}
.sidebar{overflow-y:auto;border-right:1px solid var(--border);background:var(--bg-card);display:flex;flex-direction:column}
.content{overflow-y:auto;display:flex;flex-direction:column}
.filters{padding:1rem;border-bottom:1px solid var(--border)}
.filters h2{font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em;color:var(--fg-muted);margin-bottom:0.75rem}
.filter-group{margin-bottom:0.75rem}
.filter-group label{display:block;font-size:0.75rem;color:var(--fg-dim);margin-bottom:0.3rem;font-family:var(--mono)}
.filter-group select,.filter-group input{width:100%;padding:0.4rem 0.6rem;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);color:var(--fg);font-family:var(--font);font-size:0.85rem}
.filter-group select:focus,.filter-group input:focus{outline:none;border-color:var(--ring)}
.filter-chips{display:flex;flex-wrap:wrap;gap:0.35rem;margin-top:0.35rem}
.chip{font-size:0.7rem;padding:0.2rem 0.5rem;border-radius:999px;border:1px solid var(--border);background:var(--bg);color:var(--fg-muted);cursor:pointer;font-family:var(--mono);transition:all 0.15s}
.chip:hover,.chip.active{border-color:var(--accent);color:var(--accent);background:var(--accent-fg)}
.stats-bar{display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem;padding:1rem}
.stat-card{background:var(--bg-muted);border:1px solid var(--border);border-radius:var(--radius);padding:0.75rem}
.stat-card .label{font-size:0.65rem;text-transform:uppercase;letter-spacing:0.05em;color:var(--fg-dim);font-family:var(--mono)}
.stat-card .value{font-size:1.4rem;font-weight:700;letter-spacing:-0.03em;margin-top:0.15rem}
.stat-card .sub{font-size:0.7rem;color:var(--fg-muted);font-family:var(--mono)}
.facility-list{flex:1;overflow-y:auto;padding:0.5rem}
.facility-item{padding:0.6rem 0.75rem;border-radius:var(--radius);cursor:pointer;border:1px solid transparent;margin-bottom:0.25rem;transition:all 0.15s}
.facility-item:hover{background:var(--bg-muted);border-color:var(--border)}
.facility-item.active{background:var(--bg-muted);border-color:var(--accent)}
.facility-item .fi-name{font-weight:500;font-size:0.85rem}
.facility-item .fi-company{font-size:0.75rem;color:var(--fg-muted)}
.facility-item .fi-meta{display:flex;gap:0.5rem;margin-top:0.25rem;font-size:0.7rem;font-family:var(--mono);color:var(--fg-dim)}
.fi-badge{display:inline-block;padding:0.1rem 0.4rem;border-radius:999px;font-size:0.65rem;font-weight:500}
.fi-count{font-size:0.75rem;color:var(--fg-dim);padding:0.5rem 0.75rem;font-family:var(--mono)}
.map-wrap{flex:1;position:relative;min-height:400px}
#map{width:100%;height:100%}
.dashboard{display:grid;grid-template-columns:1fr 1fr;gap:1rem;padding:1rem}
.panel{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:1rem}
.panel h3{font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em;color:var(--fg-muted);margin-bottom:0.75rem;font-family:var(--mono)}
.panel canvas{width:100%!important;max-height:250px}
.tabs{display:flex;border-bottom:1px solid var(--border);padding:0 1rem}
.tab{padding:0.6rem 1rem;font-size:0.8rem;color:var(--fg-muted);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.15s;font-family:var(--mono)}
.tab:hover{color:var(--fg)}
.tab.active{color:var(--fg);border-bottom-color:var(--accent)}
.tab-content{display:none}.tab-content.active{display:flex;flex-direction:column;flex:1;overflow:hidden}
.mapboxgl-popup-content{background:var(--bg-card)!important;color:var(--fg)!important;border:1px solid var(--border)!important;border-radius:var(--radius)!important;padding:1rem!important;font-family:var(--font)!important;min-width:260px}
.mapboxgl-popup-tip{border-top-color:var(--border)!important}
.mapboxgl-popup-close-button{color:var(--fg-muted)!important;font-size:1.2rem!important}
.popup-title{font-weight:600;font-size:0.95rem;margin-bottom:0.25rem}
.popup-company{color:var(--fg-muted);font-size:0.8rem;margin-bottom:0.5rem}
.popup-grid{display:grid;grid-template-columns:1fr 1fr;gap:0.4rem}
.popup-grid .pg-label{font-size:0.65rem;text-transform:uppercase;color:var(--fg-dim);font-family:var(--mono)}
.popup-grid .pg-value{font-size:0.85rem;font-weight:500}
.popup-funding{margin-top:0.5rem;border-top:1px solid var(--border);padding-top:0.5rem}
.popup-funding .pf-item{display:flex;justify-content:space-between;font-size:0.75rem;padding:0.15rem 0}
.popup-funding .pf-source{color:var(--fg-muted);font-family:var(--mono)}
@media(max-width:900px){
  .main{grid-template-columns:1fr}
  .sidebar{max-height:40vh}
  .dashboard{grid-template-columns:1fr}
  .stats-bar{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<div class="app">
  <header>
    <div>
      <h1>üè≠ Clean Energy Manufacturing Tracker</h1>
      <div class="subtitle">Prospector Labs ¬∑ IRA ¬∑ CHIPS Act ¬∑ DOE LPO</div>
    </div>
    <div class="header-right">
      <span style="font-size:0.7rem;font-family:var(--mono);color:var(--fg-dim)">30 facilities ¬∑ $240B+ tracked</span>
      <button class="theme-toggle" onclick="toggleTheme()">‚óê</button>
    </div>
  </header>
  <div class="main">
    <div class="sidebar">
      <div class="filters">
        <h2>Filters</h2>
        <div class="filter-group">
          <label>Technology</label>
          <div class="filter-chips" id="techFilters">
            <span class="chip active" data-val="">All</span>
            <span class="chip" data-val="solar">‚òÄ Solar</span>
            <span class="chip" data-val="battery">üîã Battery</span>
            <span class="chip" data-val="ev">üöó EV</span>
            <span class="chip" data-val="wind">üí® Wind</span>
            <span class="chip" data-val="semiconductor">üíé Semi</span>
          </div>
        </div>
        <div class="filter-group">
          <label>Status</label>
          <div class="filter-chips" id="statusFilters">
            <span class="chip active" data-val="">All</span>
            <span class="chip" data-val="announced">Announced</span>
            <span class="chip" data-val="construction">Construction</span>
            <span class="chip" data-val="operational">Operational</span>
            <span class="chip" data-val="delayed">Delayed</span>
          </div>
        </div>
        <div class="filter-group">
          <label>Funding Source</label>
          <select id="fundingFilter">
            <option value="">All Sources</option>
            <option value="IRA_48C">IRA 48C Tax Credit</option>
            <option value="CHIPS">CHIPS Act</option>
            <option value="DOE_LPO">DOE Loan Programs</option>
            <option value="state">State Incentives</option>
            <option value="private">Private</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Search</label>
          <input type="text" id="searchInput" placeholder="Company, city, state‚Ä¶">
        </div>
      </div>
      <div class="fi-count" id="facilityCount">Loading‚Ä¶</div>
      <div class="facility-list" id="facilityList"></div>
    </div>
    <div class="content">
      <div class="tabs">
        <div class="tab active" data-tab="map">Map</div>
        <div class="tab" data-tab="dashboard">Investment</div>
        <div class="tab" data-tab="jobs">Jobs</div>
        <div class="tab" data-tab="funding">Funding</div>
        <div class="tab" data-tab="timeline">Timeline</div>
      </div>
      <div class="tab-content active" id="tab-map">
        <div class="stats-bar" id="statsBar"></div>
        <div class="map-wrap"><div id="map"></div></div>
      </div>
      <div class="tab-content" id="tab-dashboard">
        <div class="stats-bar" id="statsBar2"></div>
        <div class="dashboard">
          <div class="panel"><h3>Investment by Technology</h3><canvas id="chartTech"></canvas></div>
          <div class="panel"><h3>Investment by State (Top 10)</h3><canvas id="chartState"></canvas></div>
        </div>
      </div>
      <div class="tab-content" id="tab-jobs">
        <div class="dashboard" style="grid-template-columns:1fr">
          <div class="panel"><h3>Jobs: Announced vs Created by Sector</h3><canvas id="chartJobs"></canvas></div>
        </div>
      </div>
      <div class="tab-content" id="tab-funding">
        <div class="dashboard">
          <div class="panel"><h3>Funding Source Breakdown</h3><canvas id="chartFunding"></canvas></div>
          <div class="panel"><h3>Federal vs State vs Private</h3><canvas id="chartFundingPie"></canvas></div>
        </div>
      </div>
      <div class="tab-content" id="tab-timeline">
        <div class="dashboard" style="grid-template-columns:1fr">
          <div class="panel"><h3>Facility Announcements Over Time</h3><canvas id="chartTimeline"></canvas></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const MAPBOX_TOKEN='MAPBOX_TOKEN_PLACEHOLDER';
const API_BASE=window.location.hostname==='localhost'||window.location.hostname==='127.0.0.1'?'http://localhost:8000':'';
const API_KEY='dev-key-123';
const TECH_COLORS={solar:'#facc15',battery:'#22c55e',ev:'#3b82f6',wind:'#06b6d4',semiconductor:'#a855f7',other:'#f97316'};
const STATUS_LABELS={announced:'Announced',construction:'Under Construction',operational:'Operational',delayed:'Delayed',cancelled:'Cancelled'};

let allFacilities=[],filteredFacilities=[],map,markers=[],charts={};
let filters={technology:'',status:'',funding:'',q:''};

function toggleTheme(){
  const t=document.documentElement.dataset.theme==='dark'?'light':'dark';
  document.documentElement.dataset.theme=t;
  if(map)map.setStyle(t==='dark'?'mapbox://styles/mapbox/dark-v11':'mapbox://styles/mapbox/light-v11');
  Object.values(charts).forEach(c=>c.destroy());charts={};
  setTimeout(()=>renderCharts(),500);
}

async function api(path){
  const r=await fetch(`${API_BASE}${path}`,{headers:{'X-API-Key':API_KEY}});
  return r.json();
}
function fmt$(n){if(!n)return'‚Äî';if(n>=1e9)return`$${(n/1e9).toFixed(1)}B`;if(n>=1e6)return`$${(n/1e6).toFixed(0)}M`;return`$${n.toLocaleString()}`}
function fmtNum(n){return n?n.toLocaleString():'‚Äî'}

async function init(){
  const data=await api('/v1/manufacturing/facilities?limit=500');
  allFacilities=data.data;
  applyFilters();initMap();renderCharts();setupEvents();
}

function applyFilters(){
  filteredFacilities=allFacilities.filter(f=>{
    if(filters.technology&&f.technology!==filters.technology)return false;
    if(filters.status&&f.status!==filters.status)return false;
    if(filters.q){const q=filters.q.toLowerCase();if(!((f.name||'').toLowerCase().includes(q)||(f.company||'').toLowerCase().includes(q)||(f.city||'').toLowerCase().includes(q)||(f.state||'').toLowerCase().includes(q)))return false}
    return true;
  });
  renderList();renderStats();updateMapMarkers();
}

function renderStats(){
  const ti=filteredFacilities.reduce((s,f)=>s+(f.investment_total||0),0);
  const tj=filteredFacilities.reduce((s,f)=>s+(f.jobs_announced||0),0);
  const tc=filteredFacilities.reduce((s,f)=>s+(f.jobs_created||0),0);
  const h=`<div class="stat-card"><div class="label">Facilities</div><div class="value">${filteredFacilities.length}</div></div>
    <div class="stat-card"><div class="label">Total Investment</div><div class="value">${fmt$(ti)}</div></div>
    <div class="stat-card"><div class="label">Jobs Announced</div><div class="value">${fmtNum(tj)}</div></div>
    <div class="stat-card"><div class="label">Jobs Created</div><div class="value">${fmtNum(tc)}</div><div class="sub">${tj?Math.round(tc/tj*100):0}% of announced</div></div>`;
  document.getElementById('statsBar').innerHTML=h;
  document.getElementById('statsBar2').innerHTML=h;
}

function renderList(){
  const el=document.getElementById('facilityList');
  document.getElementById('facilityCount').textContent=`${filteredFacilities.length} facilities`;
  el.innerHTML=filteredFacilities.map(f=>`
    <div class="facility-item" data-id="${f.id}" onclick="selectFacility(${f.id})">
      <div class="fi-name">${f.name}</div>
      <div class="fi-company">${f.company}</div>
      <div class="fi-meta">
        <span class="fi-badge" style="background:${TECH_COLORS[f.technology]||TECH_COLORS.other};color:#000">${f.technology}</span>
        <span>${STATUS_LABELS[f.status]||f.status}</span>
        <span>${fmt$(f.investment_total)}</span>
        <span>${f.state}</span>
      </div>
    </div>`).join('');
}

function initMap(){
  mapboxgl.accessToken=MAPBOX_TOKEN;
  map=new mapboxgl.Map({container:'map',style:'mapbox://styles/mapbox/dark-v11',center:[-98,39],zoom:3.8,attributionControl:false});
  map.addControl(new mapboxgl.NavigationControl(),'top-right');
  map.on('load',()=>updateMapMarkers());
}

function updateMapMarkers(){
  markers.forEach(m=>m.remove());markers=[];
  if(!map)return;
  filteredFacilities.forEach(f=>{
    if(!f.lat||!f.lng)return;
    const el=document.createElement('div');
    el.style.cssText=`width:14px;height:14px;border-radius:50%;background:${TECH_COLORS[f.technology]||TECH_COLORS.other};border:2px solid rgba(255,255,255,0.8);cursor:pointer;transition:transform 0.15s;`;
    el.addEventListener('mouseenter',()=>el.style.transform='scale(1.5)');
    el.addEventListener('mouseleave',()=>el.style.transform='scale(1)');
    const marker=new mapboxgl.Marker({element:el}).setLngLat([f.lng,f.lat]).addTo(map);
    marker.getElement().addEventListener('click',()=>showPopup(f));
    markers.push(marker);
  });
}

async function showPopup(f){
  const d=await api(`/v1/manufacturing/facilities/${f.id}`);
  const funding=(d.funding_sources||[]).map(s=>`<div class="pf-item"><span class="pf-source">${s.source}</span><span>${fmt$(s.amount)}</span></div>`).join('');
  new mapboxgl.Popup({maxWidth:'320px'}).setLngLat([f.lng,f.lat]).setHTML(`
    <div class="popup-title">${f.name}</div>
    <div class="popup-company">${f.company} ¬∑ ${f.city}, ${f.state}</div>
    <div class="popup-grid">
      <div><div class="pg-label">Investment</div><div class="pg-value">${fmt$(f.investment_total)}</div></div>
      <div><div class="pg-label">Status</div><div class="pg-value">${STATUS_LABELS[f.status]||f.status}</div></div>
      <div><div class="pg-label">Jobs Announced</div><div class="pg-value">${fmtNum(f.jobs_announced)}</div></div>
      <div><div class="pg-label">Jobs Created</div><div class="pg-value">${fmtNum(f.jobs_created)}</div></div>
      <div><div class="pg-label">Technology</div><div class="pg-value">${f.technology}</div></div>
      <div><div class="pg-label">Announced</div><div class="pg-value">${f.announced_date||'‚Äî'}</div></div>
    </div>
    ${funding?`<div class="popup-funding"><div class="pg-label" style="margin-bottom:0.3rem">Funding Sources</div>${funding}</div>`:''}`).addTo(map);
}

function selectFacility(id){
  document.querySelectorAll('.facility-item').forEach(e=>e.classList.remove('active'));
  const el=document.querySelector(`.facility-item[data-id="${id}"]`);
  if(el)el.classList.add('active');
  const f=allFacilities.find(x=>x.id===id);
  if(f&&map){map.flyTo({center:[f.lng,f.lat],zoom:8,duration:1000});setTimeout(()=>showPopup(f),1100);}
}

async function renderCharts(){
  const isDark=document.documentElement.dataset.theme==='dark';
  const gc=isDark?'rgba(255,255,255,0.06)':'rgba(0,0,0,0.06)';
  const tc=isDark?'#a1a1aa':'#71717a';
  Chart.defaults.color=tc;Chart.defaults.borderColor=gc;Chart.defaults.font.family="'Geist',system-ui,sans-serif";

  const invTech=await api('/v1/manufacturing/investments?group_by=technology');
  charts.tech=new Chart(document.getElementById('chartTech'),{type:'bar',data:{labels:invTech.data.map(d=>d.technology),datasets:[{label:'Investment ($B)',data:invTech.data.map(d=>d.total_investment/1e9),backgroundColor:invTech.data.map(d=>TECH_COLORS[d.technology]||TECH_COLORS.other),borderRadius:4}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{grid:{color:gc},ticks:{callback:v=>'$'+v+'B'}},x:{grid:{display:false}}}}});

  const invState=await api('/v1/manufacturing/investments?group_by=state');
  const top10=invState.data.slice(0,10);
  charts.state=new Chart(document.getElementById('chartState'),{type:'bar',data:{labels:top10.map(d=>d.state),datasets:[{label:'Investment ($B)',data:top10.map(d=>d.total_investment/1e9),backgroundColor:'hsl(142 71% 45%)',borderRadius:4}]},options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false}},scales:{x:{grid:{color:gc},ticks:{callback:v=>'$'+v+'B'}},y:{grid:{display:false}}}}});

  const jobs=await api('/v1/manufacturing/jobs');
  charts.jobs=new Chart(document.getElementById('chartJobs'),{type:'bar',data:{labels:jobs.data.map(d=>d.technology),datasets:[{label:'Announced',data:jobs.data.map(d=>d.jobs_announced),backgroundColor:'hsl(142 71% 45%)',borderRadius:4},{label:'Created',data:jobs.data.map(d=>d.jobs_created),backgroundColor:'hsl(217 91% 60%)',borderRadius:4}]},options:{responsive:true,scales:{y:{grid:{color:gc},ticks:{callback:v=>v>=1000?(v/1000)+'K':v}},x:{grid:{display:false}}}}});

  const fund=await api('/v1/manufacturing/funding');
  const srcLabels={IRA_48C:'IRA 48C',CHIPS:'CHIPS Act',DOE_LPO:'DOE LPO',state:'State',private:'Private'};
  const srcColors={IRA_48C:'#facc15',CHIPS:'#a855f7',DOE_LPO:'#3b82f6',state:'#06b6d4',private:'#22c55e'};
  charts.funding=new Chart(document.getElementById('chartFunding'),{type:'bar',data:{labels:fund.data.map(d=>srcLabels[d.source]||d.source),datasets:[{label:'Amount ($B)',data:fund.data.map(d=>d.total_amount/1e9),backgroundColor:fund.data.map(d=>srcColors[d.source]||'#888'),borderRadius:4}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{grid:{color:gc},ticks:{callback:v=>'$'+v+'B'}},x:{grid:{display:false}}}}});

  const groups={Federal:0,State:0,Private:0};
  fund.data.forEach(d=>{if(['IRA_48C','CHIPS','DOE_LPO'].includes(d.source))groups.Federal+=d.total_amount;else if(d.source==='state')groups.State+=d.total_amount;else groups.Private+=d.total_amount});
  charts.fundingPie=new Chart(document.getElementById('chartFundingPie'),{type:'doughnut',data:{labels:Object.keys(groups),datasets:[{data:Object.values(groups).map(v=>v/1e9),backgroundColor:['#a855f7','#06b6d4','#22c55e'],borderWidth:0}]},options:{responsive:true,plugins:{legend:{position:'bottom'}}}});

  const byYear={},invByYear={};
  allFacilities.forEach(f=>{if(!f.announced_date)return;const y=f.announced_date.substring(0,4);byYear[y]=(byYear[y]||0)+1;invByYear[y]=(invByYear[y]||0)+(f.investment_total||0)});
  const years=Object.keys(byYear).sort();
  charts.timeline=new Chart(document.getElementById('chartTimeline'),{type:'bar',data:{labels:years,datasets:[{label:'Facilities Announced',data:years.map(y=>byYear[y]||0),backgroundColor:'hsl(142 71% 45%)',borderRadius:4,yAxisID:'y'},{label:'Investment ($B)',data:years.map(y=>(invByYear[y]||0)/1e9),type:'line',borderColor:'#facc15',backgroundColor:'rgba(250,204,21,0.1)',fill:true,tension:0.3,yAxisID:'y1'}]},options:{responsive:true,scales:{y:{grid:{color:gc},title:{display:true,text:'# Facilities'}},y1:{position:'right',grid:{display:false},title:{display:true,text:'Investment ($B)'},ticks:{callback:v=>'$'+v+'B'}},x:{grid:{display:false}}}}});
}

function setupEvents(){
  document.querySelectorAll('#techFilters .chip').forEach(el=>{el.addEventListener('click',()=>{document.querySelectorAll('#techFilters .chip').forEach(c=>c.classList.remove('active'));el.classList.add('active');filters.technology=el.dataset.val;applyFilters()})});
  document.querySelectorAll('#statusFilters .chip').forEach(el=>{el.addEventListener('click',()=>{document.querySelectorAll('#statusFilters .chip').forEach(c=>c.classList.remove('active'));el.classList.add('active');filters.status=el.dataset.val;applyFilters()})});
  document.getElementById('fundingFilter').addEventListener('change',async e=>{filters.funding=e.target.value;if(filters.funding){const data=await api(`/v1/manufacturing/facilities?funding_source=${filters.funding}&limit=500`);const ids=new Set(data.data.map(f=>f.id));filteredFacilities=filteredFacilities.filter(f=>ids.has(f.id));renderList();renderStats();updateMapMarkers()}else{applyFilters()}});
  document.getElementById('searchInput').addEventListener('input',e=>{filters.q=e.target.value;applyFilters()});
  document.querySelectorAll('.tab').forEach(el=>{el.addEventListener('click',()=>{document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));el.classList.add('active');document.getElementById('tab-'+el.dataset.tab).classList.add('active');if(el.dataset.tab==='map')setTimeout(()=>map?.resize(),100)})});
}

init();
</script>
</body>
</html>
