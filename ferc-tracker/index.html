<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FERC Order Tracker ‚Äî Prospector Labs</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&family=Geist+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:hsl(0 0% 3.9%);--bg-card:hsl(0 0% 5.5%);--bg-muted:hsl(0 0% 9%);
  --border:hsl(0 0% 14.9%);--ring:hsl(0 0% 83.1%);
  --fg:hsl(0 0% 98%);--fg-muted:hsl(0 0% 63.9%);--fg-dim:hsl(0 0% 45%);
  --accent:hsl(217 91% 60%);--accent-fg:hsl(0 0% 98%);
  --destructive:hsl(0 84% 60%);--success:hsl(142 76% 36%);
  --warning:hsl(38 92% 50%);
  --radius:0.5rem;--font:Geist,system-ui,sans-serif;--mono:Geist Mono,monospace;
}
html.light{
  --bg:hsl(0 0% 100%);--bg-card:hsl(0 0% 98%);--bg-muted:hsl(0 0% 96.1%);
  --border:hsl(0 0% 89.8%);--ring:hsl(0 0% 3.9%);
  --fg:hsl(0 0% 3.9%);--fg-muted:hsl(0 0% 45.1%);--fg-dim:hsl(0 0% 63.9%);
}
body{font-family:var(--font);background:var(--bg);color:var(--fg);line-height:1.6;min-height:100vh}
a{color:var(--accent);text-decoration:none}a:hover{text-decoration:underline}
code,.mono{font-family:var(--mono)}

/* Layout */
.app{display:grid;grid-template-columns:280px 1fr;grid-template-rows:56px 1fr;height:100vh;overflow:hidden}
.header{grid-column:1/-1;display:flex;align-items:center;gap:16px;padding:0 24px;border-bottom:1px solid var(--border);background:var(--bg-card)}
.sidebar{border-right:1px solid var(--border);overflow-y:auto;padding:16px;background:var(--bg-card)}
.main{overflow-y:auto;padding:24px}

/* Header */
.logo{font-weight:700;font-size:15px;letter-spacing:-0.02em}
.logo span{color:var(--fg-muted);font-weight:400;margin-left:6px}
.search-wrap{flex:1;max-width:560px;position:relative}
.search-wrap input{width:100%;background:var(--bg-muted);border:1px solid var(--border);border-radius:var(--radius);padding:8px 12px 8px 36px;color:var(--fg);font-size:14px;font-family:var(--font);outline:none;transition:border .15s}
.search-wrap input:focus{border-color:var(--accent)}
.search-wrap svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--fg-muted);width:16px;height:16px}
.header-actions{display:flex;align-items:center;gap:8px;margin-left:auto}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:var(--radius);font-size:13px;font-weight:500;font-family:var(--font);cursor:pointer;border:1px solid var(--border);background:var(--bg-muted);color:var(--fg);transition:all .15s}
.btn:hover{background:var(--border)}
.btn-primary{background:var(--accent);color:var(--accent-fg);border-color:var(--accent)}
.btn-primary:hover{opacity:.9}
.btn-sm{padding:4px 10px;font-size:12px}
.btn-ghost{background:transparent;border-color:transparent}
.btn-ghost:hover{background:var(--bg-muted)}

/* Sidebar */
.sidebar h3{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--fg-dim);margin:16px 0 8px;font-weight:600}
.sidebar h3:first-child{margin-top:0}
.filter-group{display:flex;flex-direction:column;gap:2px}
.filter-item{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;border-radius:calc(var(--radius) - 2px);font-size:13px;cursor:pointer;transition:background .1s;color:var(--fg-muted)}
.filter-item:hover,.filter-item.active{background:var(--bg-muted);color:var(--fg)}
.filter-item .count{font-family:var(--mono);font-size:11px;color:var(--fg-dim)}
.filter-item.active .count{color:var(--accent)}
.date-input{width:100%;background:var(--bg-muted);border:1px solid var(--border);border-radius:calc(var(--radius) - 2px);padding:6px 10px;color:var(--fg);font-size:13px;font-family:var(--font)}
.date-row{display:flex;gap:8px;margin-bottom:4px}
.date-row label{font-size:11px;color:var(--fg-dim);display:block;margin-bottom:2px}
.date-row > div{flex:1}

/* Tabs */
.tabs{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:20px}
.tab{padding:8px 16px;font-size:13px;font-weight:500;color:var(--fg-muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s}
.tab:hover{color:var(--fg)}
.tab.active{color:var(--fg);border-bottom-color:var(--accent)}

/* Cards */
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.card-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:8px}
.card h4{font-size:14px;font-weight:500;line-height:1.4}
.card p{font-size:13px;color:var(--fg-muted);line-height:1.5}
.meta{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;font-size:12px;color:var(--fg-dim)}
.meta span{display:inline-flex;align-items:center;gap:4px}

/* Tags */
.tag{display:inline-flex;align-items:center;padding:2px 8px;border-radius:9999px;font-size:11px;font-weight:500;border:1px solid var(--border);background:var(--bg-muted);color:var(--fg-muted)}
.tag-er{border-color:hsl(217 70% 35%);color:hsl(217 91% 70%);background:hsl(217 91% 60%/.1)}
.tag-cp{border-color:hsl(38 70% 35%);color:hsl(38 92% 60%);background:hsl(38 92% 50%/.1)}
.tag-rm{border-color:hsl(280 70% 35%);color:hsl(280 70% 65%);background:hsl(280 70% 50%/.1)}
.tag-el{border-color:hsl(0 60% 35%);color:hsl(0 84% 65%);background:hsl(0 84% 60%/.1)}
.tag-p{border-color:hsl(142 50% 30%);color:hsl(142 76% 50%);background:hsl(142 76% 36%/.1)}
.tag-ec{border-color:hsl(180 50% 30%);color:hsl(180 60% 55%);background:hsl(180 60% 40%/.1)}
.tag-ad{border-color:hsl(0 0% 30%);color:var(--fg-muted);background:var(--bg-muted)}
.tag-status{font-family:var(--mono);font-size:10px;text-transform:uppercase;letter-spacing:.04em}

/* Stats grid */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
.stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
.stat-card .label{font-size:12px;color:var(--fg-muted);margin-bottom:4px}
.stat-card .value{font-size:28px;font-weight:700;font-family:var(--mono);letter-spacing:-0.02em}
.stat-card .sub{font-size:11px;color:var(--fg-dim);margin-top:2px}

/* Charts */
.chart-container{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px}
.chart-container h3{font-size:14px;font-weight:600;margin-bottom:12px}
.chart-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}

/* Entity list */
.entity-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.entity-chip{padding:3px 10px;border-radius:9999px;font-size:12px;cursor:pointer;background:var(--bg-muted);border:1px solid var(--border);color:var(--fg-muted);transition:all .15s}
.entity-chip:hover{border-color:var(--accent);color:var(--accent)}

/* Detail panel */
.detail-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;display:none;align-items:center;justify-content:center}
.detail-overlay.open{display:flex}
.detail-panel{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);width:720px;max-height:85vh;overflow-y:auto;padding:24px}
.detail-panel h2{font-size:18px;font-weight:600;margin-bottom:4px}
.detail-panel .docket{font-family:var(--mono);color:var(--accent);font-size:13px;margin-bottom:12px}
.detail-section{margin-top:16px}
.detail-section h4{font-size:12px;text-transform:uppercase;letter-spacing:.06em;color:var(--fg-dim);margin-bottom:6px}

/* Alert modal */
.alert-modal{width:480px}
.alert-modal .form-group{margin-bottom:12px}
.alert-modal label{font-size:12px;color:var(--fg-muted);display:block;margin-bottom:4px}
.alert-modal select,.alert-modal input[type="text"]{width:100%;background:var(--bg-muted);border:1px solid var(--border);border-radius:calc(var(--radius) - 2px);padding:8px 10px;color:var(--fg);font-size:13px;font-family:var(--font)}

/* Responsive */
@media(max-width:900px){
  .app{grid-template-columns:1fr}
  .sidebar{display:none}
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .chart-row{grid-template-columns:1fr}
}

/* Loading */
.loading{text-align:center;padding:40px;color:var(--fg-muted)}
.spinner{display:inline-block;width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Empty */
.empty{text-align:center;padding:60px 20px;color:var(--fg-dim)}
.empty h3{font-size:16px;color:var(--fg-muted);margin-bottom:8px}
</style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <header class="header">
    <div class="logo">FERC Tracker<span>by Prospector Labs</span></div>
    <div class="search-wrap">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
      <input type="text" id="searchInput" placeholder="Search orders, dockets, entities‚Ä¶" />
    </div>
    <div class="header-actions">
      <button class="btn btn-sm" onclick="openAlertModal()">üîî Alerts</button>
      <button class="btn btn-sm btn-ghost" id="themeToggle" onclick="toggleTheme()">‚òÄÔ∏è</button>
    </div>
  </header>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <h3>Docket Type</h3>
    <div class="filter-group" id="docketFilters"></div>

    <h3>Filing Type</h3>
    <div class="filter-group" id="filingTypeFilters"></div>

    <h3>Topic</h3>
    <div class="filter-group" id="topicFilters"></div>

    <h3>Date Range</h3>
    <div class="date-row">
      <div><label>From</label><input type="date" class="date-input" id="dateFrom"></div>
      <div><label>To</label><input type="date" class="date-input" id="dateTo"></div>
    </div>

    <h3>Top Entities</h3>
    <div class="filter-group" id="entityFilters"></div>
  </aside>

  <!-- Main -->
  <main class="main" id="mainContent">
    <div class="tabs" id="tabBar">
      <div class="tab active" data-tab="feed">Filing Feed</div>
      <div class="tab" data-tab="stats">Stats & Trends</div>
      <div class="tab" data-tab="entities">Entity Explorer</div>
    </div>

    <div id="feedView"></div>
    <div id="statsView" style="display:none"></div>
    <div id="entitiesView" style="display:none"></div>
  </main>
</div>

<!-- Detail Overlay -->
<div class="detail-overlay" id="detailOverlay" onclick="if(event.target===this)closeDetail()">
  <div class="detail-panel" id="detailPanel"></div>
</div>

<!-- Alert Modal -->
<div class="detail-overlay" id="alertOverlay" onclick="if(event.target===this)closeAlertModal()">
  <div class="detail-panel alert-modal">
    <h2 style="margin-bottom:16px">Set Up Filing Alert</h2>
    <div class="form-group">
      <label>Alert Name</label>
      <input type="text" placeholder="e.g. PJM Rate Changes" id="alertName">
    </div>
    <div class="form-group">
      <label>Docket Type</label>
      <select id="alertDocketType"><option value="">Any</option></select>
    </div>
    <div class="form-group">
      <label>Topic Contains</label>
      <input type="text" placeholder="e.g. Transmission Planning" id="alertTopic">
    </div>
    <div class="form-group">
      <label>Entity Contains</label>
      <input type="text" placeholder="e.g. PJM" id="alertEntity">
    </div>
    <div class="form-group">
      <label>Notify via</label>
      <select id="alertMethod">
        <option value="email">Email</option>
        <option value="webhook">Webhook</option>
        <option value="slack">Slack</option>
      </select>
    </div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="btn btn-primary" onclick="saveAlert()">Save Alert</button>
      <button class="btn" onclick="closeAlertModal()">Cancel</button>
    </div>
    <div id="savedAlerts" style="margin-top:20px"></div>
  </div>
</div>

<script>
// --- Config ---
const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
  ? `${window.location.protocol}//${window.location.hostname}:8000/v1/ferc-tracker`
  : '/v1/ferc-tracker';
const API_KEY = 'demo-key';

const DOCKET_LABELS = {ER:'Electric Rate',CP:'Pipeline/LNG',P:'Hydroelectric',RM:'Rulemaking',EL:'Complaint',EC:'Merger',AD:'Administrative'};
const DOCKET_COLORS = {ER:'tag-er',CP:'tag-cp',P:'tag-p',RM:'tag-rm',EL:'tag-el',EC:'tag-ec',AD:'tag-ad'};

// --- State ---
let state = {
  filings: [],
  stats: null,
  filters: { docket_type: null, topic: null, entity: null, filing_type: null, q: null, start_date: null, end_date: null },
  activeTab: 'feed',
  alerts: JSON.parse(localStorage.getItem('ferc_alerts') || '[]'),
};

// --- API ---
async function api(path, params = {}) {
  const url = new URL(API_BASE + path, window.location.origin);
  Object.entries(params).forEach(([k,v]) => { if (v != null && v !== '') url.searchParams.set(k, v); });
  try {
    const r = await fetch(url, { headers: { 'X-API-Key': API_KEY } });
    if (!r.ok) throw new Error(`${r.status}`);
    return await r.json();
  } catch(e) {
    console.warn('API error:', e);
    return null;
  }
}

// --- Fetch & Render ---
async function loadFilings() {
  const el = document.getElementById('feedView');
  if (state.activeTab !== 'feed') return;
  el.innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top:8px">Loading filings‚Ä¶</p></div>';
  const f = state.filters;
  const data = await api('/orders', { ...f, limit: 100 });
  if (!data || data.length === 0) {
    el.innerHTML = '<div class="empty"><h3>No filings found</h3><p>Try adjusting your filters or search query.</p></div>';
    return;
  }
  state.filings = data;
  el.innerHTML = data.map(renderFiling).join('');
}

async function loadStats() {
  const el = document.getElementById('statsView');
  if (state.activeTab !== 'stats') return;
  el.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  const data = await api('/stats');
  if (!data) { el.innerHTML = '<div class="empty"><h3>Stats unavailable</h3></div>'; return; }
  state.stats = data;
  renderStats(data);
}

async function loadEntities() {
  const el = document.getElementById('entitiesView');
  if (state.activeTab !== 'entities') return;
  if (!state.stats) state.stats = await api('/stats');
  if (!state.stats) { el.innerHTML = '<div class="empty"><h3>Data unavailable</h3></div>'; return; }
  renderEntitiesView(state.stats.top_entities);
}

// --- Render Filing Card ---
function renderFiling(f) {
  const dtClass = DOCKET_COLORS[f.docket_type] || 'tag-ad';
  const dtLabel = DOCKET_LABELS[f.docket_type] || f.docket_type;
  const entities = (f.entities || []).slice(0, 3).map(e =>
    `<span class="entity-chip" onclick="event.stopPropagation();filterByEntity('${escHtml(e)}')">${escHtml(e)}</span>`
  ).join('');
  return `
    <div class="card" onclick="openDetail('${escHtml(f.docket_number)}','${escHtml(f.accession_number)}')" style="cursor:pointer">
      <div class="card-header">
        <div>
          <h4>${escHtml(f.title)}</h4>
          <div class="meta" style="margin-top:4px">
            <span class="tag ${dtClass}">${dtLabel}</span>
            <span class="tag tag-status">${escHtml(f.status)}</span>
            <span class="mono" style="color:var(--accent)">${escHtml(f.docket_number)}</span>
          </div>
        </div>
        <div style="text-align:right;white-space:nowrap;font-size:12px;color:var(--fg-dim)">${f.filed_date}</div>
      </div>
      ${f.summary ? `<p style="margin-top:4px">${escHtml(f.summary).substring(0,200)}${f.summary.length>200?'‚Ä¶':''}</p>` : ''}
      <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:8px">
        ${(f.topics||[]).map(t=>`<span class="tag">${escHtml(t)}</span>`).join('')}
      </div>
      <div class="entity-list">${entities}</div>
    </div>`;
}

// --- Render Stats ---
function renderStats(s) {
  const el = document.getElementById('statsView');
  el.innerHTML = `
    <div class="stats-grid">
      <div class="stat-card"><div class="label">Total Filings</div><div class="value">${s.total_filings.toLocaleString()}</div></div>
      <div class="stat-card"><div class="label">Last 24 Hours</div><div class="value">${s.filings_last_24h}</div></div>
      <div class="stat-card"><div class="label">Last 7 Days</div><div class="value">${s.filings_last_7d}</div></div>
      <div class="stat-card"><div class="label">Last 30 Days</div><div class="value">${s.filings_last_30d}</div></div>
    </div>
    <div class="chart-row">
      <div class="chart-container"><h3>Filing Volume (90 Days)</h3><canvas id="volumeChart"></canvas></div>
      <div class="chart-container"><h3>By Docket Type</h3><canvas id="typeChart"></canvas></div>
    </div>
    <div class="chart-row" style="margin-top:16px">
      <div class="chart-container"><h3>Trending Topics</h3><div id="topicBars"></div></div>
      <div class="chart-container"><h3>Most Active Entities</h3><div id="entityBars"></div></div>
    </div>`;

  // Volume chart
  const vCtx = document.getElementById('volumeChart').getContext('2d');
  const fg = getComputedStyle(document.documentElement).getPropertyValue('--fg-muted').trim();
  const gridC = getComputedStyle(document.documentElement).getPropertyValue('--border').trim();
  new Chart(vCtx, {
    type: 'line',
    data: {
      labels: s.daily_volume.map(d => d.date),
      datasets: [{
        data: s.daily_volume.map(d => d.count),
        borderColor: 'hsl(217,91%,60%)',
        backgroundColor: 'hsla(217,91%,60%,0.1)',
        fill: true, tension: 0.3, pointRadius: 0,
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } },
      scales: { x: { ticks: { color: fg, maxTicksLimit: 10 }, grid: { color: gridC } },
                y: { ticks: { color: fg }, grid: { color: gridC } } } }
  });

  // Type pie
  const tCtx = document.getElementById('typeChart').getContext('2d');
  const typeKeys = Object.keys(s.by_docket_type);
  const typeColors = ['#3b82f6','#f59e0b','#8b5cf6','#ef4444','#22c55e','#06b6d4','#6b7280'];
  new Chart(tCtx, {
    type: 'doughnut',
    data: {
      labels: typeKeys.map(k => DOCKET_LABELS[k]||k),
      datasets: [{ data: typeKeys.map(k=>s.by_docket_type[k]), backgroundColor: typeColors.slice(0,typeKeys.length) }]
    },
    options: { responsive: true, plugins: { legend: { position: 'right', labels: { color: fg, font: { size: 12 } } } } }
  });

  // Topic bars
  const topicEl = document.getElementById('topicBars');
  const topicEntries = Object.entries(s.by_topic).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const maxTopic = topicEntries[0]?.[1] || 1;
  topicEl.innerHTML = topicEntries.map(([t,c]) => `
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;cursor:pointer" onclick="filterByTopic('${escHtml(t)}')">
      <div style="width:140px;font-size:12px;color:var(--fg-muted);text-align:right;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escHtml(t)}">${escHtml(t)}</div>
      <div style="flex:1;background:var(--bg-muted);border-radius:4px;height:20px;overflow:hidden">
        <div style="width:${(c/maxTopic*100).toFixed(1)}%;height:100%;background:var(--accent);border-radius:4px"></div>
      </div>
      <div class="mono" style="font-size:11px;color:var(--fg-dim);width:30px">${c}</div>
    </div>
  `).join('');

  // Entity bars
  const entEl = document.getElementById('entityBars');
  const maxEnt = s.top_entities[0]?.count || 1;
  entEl.innerHTML = s.top_entities.slice(0,10).map(e => `
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;cursor:pointer" onclick="filterByEntity('${escHtml(e.name)}')">
      <div style="width:160px;font-size:12px;color:var(--fg-muted);text-align:right;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escHtml(e.name)}">${escHtml(e.name)}</div>
      <div style="flex:1;background:var(--bg-muted);border-radius:4px;height:20px;overflow:hidden">
        <div style="width:${(e.count/maxEnt*100).toFixed(1)}%;height:100%;background:hsl(142,76%,36%);border-radius:4px"></div>
      </div>
      <div class="mono" style="font-size:11px;color:var(--fg-dim);width:30px">${e.count}</div>
    </div>
  `).join('');
}

// --- Render Entities View ---
function renderEntitiesView(entities) {
  const el = document.getElementById('entitiesView');
  el.innerHTML = `
    <div style="margin-bottom:16px">
      <input type="text" id="entitySearch" placeholder="Search entities‚Ä¶"
        style="width:100%;max-width:400px;background:var(--bg-muted);border:1px solid var(--border);border-radius:var(--radius);padding:8px 12px;color:var(--fg);font-size:14px;font-family:var(--font)">
    </div>
    <div id="entityGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px"></div>
    <div id="entityDetail" style="margin-top:20px"></div>`;
  renderEntityGrid(entities);
  document.getElementById('entitySearch').addEventListener('input', e => {
    const q = e.target.value.toLowerCase();
    renderEntityGrid(entities.filter(en => en.name.toLowerCase().includes(q)));
  });
}

function renderEntityGrid(entities) {
  document.getElementById('entityGrid').innerHTML = entities.map(e => `
    <div class="card" style="cursor:pointer" onclick="loadEntityDetail('${escHtml(e.name)}')">
      <h4>${escHtml(e.name)}</h4>
      <div class="mono" style="font-size:22px;font-weight:700;margin:4px 0">${e.count}</div>
      <div style="font-size:12px;color:var(--fg-dim)">filings</div>
    </div>
  `).join('');
}

async function loadEntityDetail(name) {
  const el = document.getElementById('entityDetail');
  el.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  const data = await api(`/entities/${encodeURIComponent(name)}`);
  if (!data) { el.innerHTML = ''; return; }
  el.innerHTML = `
    <div class="card">
      <h4 style="font-size:18px;margin-bottom:8px">${escHtml(data.entity_name)}</h4>
      <div class="meta" style="margin-bottom:12px">
        <span>${data.filing_count} total filings</span>
        ${Object.entries(data.docket_types).map(([k,v])=>`<span class="tag ${DOCKET_COLORS[k]||''}">${DOCKET_LABELS[k]||k}: ${v}</span>`).join('')}
      </div>
      ${data.recent_filings.slice(0,10).map(renderFiling).join('')}
    </div>`;
  el.scrollIntoView({ behavior: 'smooth' });
}

// --- Detail Panel ---
async function openDetail(docket, accession) {
  const overlay = document.getElementById('detailOverlay');
  const panel = document.getElementById('detailPanel');
  panel.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  overlay.classList.add('open');

  const data = await api(`/orders/${encodeURIComponent(docket)}`);
  if (!data) { panel.innerHTML = '<p>Error loading docket</p>'; return; }

  const current = data.filings.find(f => f.accession_number === accession) || data.filings[0];

  panel.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div>
        <h2>${escHtml(current.title)}</h2>
        <div class="docket">${escHtml(data.docket_number)} ¬∑ ${DOCKET_LABELS[data.docket_type]||data.docket_type}</div>
      </div>
      <button class="btn btn-sm btn-ghost" onclick="closeDetail()">‚úï</button>
    </div>
    <div class="meta" style="margin-bottom:12px">
      <span class="tag ${DOCKET_COLORS[current.docket_type]||''}">${DOCKET_LABELS[current.docket_type]||current.docket_type}</span>
      <span class="tag tag-status">${escHtml(current.status)}</span>
      <span>Filed: ${current.filed_date}</span>
      ${current.issued_date ? `<span>Issued: ${current.issued_date}</span>` : ''}
      <span>${escHtml(current.filing_type)}</span>
    </div>
    ${current.summary ? `<div class="detail-section"><h4>Summary</h4><p>${escHtml(current.summary)}</p></div>` : ''}
    <div class="detail-section">
      <h4>Entities Involved</h4>
      <div class="entity-list">${(current.entities||[]).map(e=>`<span class="entity-chip" onclick="closeDetail();filterByEntity('${escHtml(e)}')">${escHtml(e)}</span>`).join('')}</div>
    </div>
    <div class="detail-section">
      <h4>Topics</h4>
      <div style="display:flex;flex-wrap:wrap;gap:4px">${(current.topics||[]).map(t=>`<span class="tag">${escHtml(t)}</span>`).join('')}</div>
    </div>
    ${current.related_dockets?.length ? `<div class="detail-section"><h4>Related Dockets</h4><div style="display:flex;flex-wrap:wrap;gap:6px">${current.related_dockets.map(d=>`<a class="mono" style="font-size:13px" href="#" onclick="event.preventDefault();closeDetail();setTimeout(()=>openDetail('${escHtml(d)}',''),100)">${escHtml(d)}</a>`).join('')}</div></div>` : ''}
    ${data.filings.length > 1 ? `
      <div class="detail-section">
        <h4>Docket Timeline (${data.filings.length} filings)</h4>
        ${data.filings.map(f => `
          <div style="display:flex;gap:12px;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px;${f.accession_number===accession?'background:var(--bg-muted);margin:0 -8px;padding:8px;border-radius:4px':''}">
            <div class="mono" style="color:var(--fg-dim);width:90px;flex-shrink:0">${f.filed_date}</div>
            <div style="flex:1">
              <div style="font-weight:500">${escHtml(f.filing_type)}</div>
              <div style="color:var(--fg-muted)">${escHtml((f.title||'').substring(0,100))}</div>
            </div>
            <span class="tag tag-status">${escHtml(f.status)}</span>
          </div>
        `).join('')}
      </div>` : ''}
    <div class="detail-section">
      <h4>Source</h4>
      <a href="${current.source_url||'#'}" target="_blank" style="font-size:13px">${current.source_url ? 'View on FERC eLibrary ‚Üí' : 'Not available'}</a>
    </div>`;
}

function closeDetail() { document.getElementById('detailOverlay').classList.remove('open'); }

// --- Alerts ---
function openAlertModal() { document.getElementById('alertOverlay').classList.add('open'); renderSavedAlerts(); }
function closeAlertModal() { document.getElementById('alertOverlay').classList.remove('open'); }
function saveAlert() {
  const alert = {
    id: Date.now(),
    name: document.getElementById('alertName').value || 'Unnamed Alert',
    docket_type: document.getElementById('alertDocketType').value,
    topic: document.getElementById('alertTopic').value,
    entity: document.getElementById('alertEntity').value,
    method: document.getElementById('alertMethod').value,
    created: new Date().toISOString(),
  };
  state.alerts.push(alert);
  localStorage.setItem('ferc_alerts', JSON.stringify(state.alerts));
  document.getElementById('alertName').value = '';
  document.getElementById('alertTopic').value = '';
  document.getElementById('alertEntity').value = '';
  renderSavedAlerts();
}
function deleteAlert(id) {
  state.alerts = state.alerts.filter(a => a.id !== id);
  localStorage.setItem('ferc_alerts', JSON.stringify(state.alerts));
  renderSavedAlerts();
}
function renderSavedAlerts() {
  const el = document.getElementById('savedAlerts');
  if (!state.alerts.length) { el.innerHTML = '<p style="font-size:13px;color:var(--fg-dim)">No alerts configured.</p>'; return; }
  el.innerHTML = '<h4 style="font-size:12px;text-transform:uppercase;color:var(--fg-dim);margin-bottom:8px">Active Alerts</h4>' +
    state.alerts.map(a => `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:var(--bg-muted);border-radius:var(--radius);margin-bottom:6px;font-size:13px">
        <div>
          <strong>${escHtml(a.name)}</strong>
          <span style="color:var(--fg-dim);margin-left:8px">${[a.docket_type,a.topic,a.entity].filter(Boolean).join(' ¬∑ ') || 'All filings'}</span>
        </div>
        <button class="btn btn-sm btn-ghost" onclick="deleteAlert(${a.id})" style="color:var(--destructive)">‚úï</button>
      </div>
    `).join('');
}

// --- Filters ---
function setFilter(key, value) {
  state.filters[key] = state.filters[key] === value ? null : value;
  updateFilterUI();
  loadFilings();
}
function filterByEntity(name) {
  switchTab('feed');
  state.filters.entity = name;
  updateFilterUI();
  loadFilings();
}
function filterByTopic(topic) {
  switchTab('feed');
  state.filters.topic = topic;
  updateFilterUI();
  loadFilings();
}
function clearFilters() {
  state.filters = { docket_type:null, topic:null, entity:null, filing_type:null, q:null, start_date:null, end_date:null };
  document.getElementById('searchInput').value = '';
  document.getElementById('dateFrom').value = '';
  document.getElementById('dateTo').value = '';
  updateFilterUI();
  loadFilings();
}

function updateFilterUI() {
  document.querySelectorAll('.filter-item').forEach(el => {
    const key = el.dataset.filterKey;
    const val = el.dataset.filterValue;
    el.classList.toggle('active', state.filters[key] === val);
  });
}

// --- Build Sidebar ---
async function buildSidebar() {
  const stats = await api('/stats');
  if (!stats) return;

  // Docket types
  const df = document.getElementById('docketFilters');
  df.innerHTML = Object.entries(stats.by_docket_type).map(([k,v]) =>
    `<div class="filter-item" data-filter-key="docket_type" data-filter-value="${k}" onclick="setFilter('docket_type','${k}')">
      <span><span class="tag ${DOCKET_COLORS[k]||''}" style="margin-right:6px">${k}</span>${DOCKET_LABELS[k]||k}</span>
      <span class="count">${v}</span>
    </div>`
  ).join('');

  // Filing types
  const ft = document.getElementById('filingTypeFilters');
  const ftEntries = Object.entries(stats.by_filing_type).sort((a,b)=>b[1]-a[1]).slice(0,8);
  ft.innerHTML = ftEntries.map(([k,v]) =>
    `<div class="filter-item" data-filter-key="filing_type" data-filter-value="${k}" onclick="setFilter('filing_type','${k}')">
      <span>${escHtml(k)}</span><span class="count">${v}</span>
    </div>`
  ).join('');

  // Topics
  const tp = document.getElementById('topicFilters');
  const tpEntries = Object.entries(stats.by_topic).sort((a,b)=>b[1]-a[1]).slice(0,10);
  tp.innerHTML = tpEntries.map(([k,v]) =>
    `<div class="filter-item" data-filter-key="topic" data-filter-value="${k}" onclick="setFilter('topic','${k}')">
      <span>${escHtml(k)}</span><span class="count">${v}</span>
    </div>`
  ).join('');

  // Entities
  const ef = document.getElementById('entityFilters');
  ef.innerHTML = stats.top_entities.slice(0,8).map(e =>
    `<div class="filter-item" data-filter-key="entity" data-filter-value="${e.name}" onclick="setFilter('entity','${e.name}')">
      <span>${escHtml(e.name)}</span><span class="count">${e.count}</span>
    </div>`
  ).join('');

  // Alert modal docket type select
  const sel = document.getElementById('alertDocketType');
  Object.entries(DOCKET_LABELS).forEach(([k,v]) => {
    const opt = document.createElement('option');
    opt.value = k; opt.textContent = `${k} ‚Äî ${v}`;
    sel.appendChild(opt);
  });
}

// --- Tabs ---
function switchTab(tab) {
  state.activeTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  document.getElementById('feedView').style.display = tab === 'feed' ? '' : 'none';
  document.getElementById('statsView').style.display = tab === 'stats' ? '' : 'none';
  document.getElementById('entitiesView').style.display = tab === 'entities' ? '' : 'none';
  if (tab === 'feed') loadFilings();
  else if (tab === 'stats') loadStats();
  else if (tab === 'entities') loadEntities();
}

document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab)));

// --- Search ---
let searchTimeout;
document.getElementById('searchInput').addEventListener('input', e => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    state.filters.q = e.target.value || null;
    if (state.activeTab !== 'feed') switchTab('feed');
    else loadFilings();
  }, 300);
});

// --- Date filters ---
document.getElementById('dateFrom').addEventListener('change', e => { state.filters.start_date = e.target.value || null; loadFilings(); });
document.getElementById('dateTo').addEventListener('change', e => { state.filters.end_date = e.target.value || null; loadFilings(); });

// --- Theme ---
function toggleTheme() {
  const html = document.documentElement;
  html.classList.toggle('dark');
  html.classList.toggle('light');
  document.getElementById('themeToggle').textContent = html.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('ferc_theme', html.classList.contains('dark') ? 'dark' : 'light');
}
const saved = localStorage.getItem('ferc_theme');
if (saved === 'light') { document.documentElement.classList.remove('dark'); document.documentElement.classList.add('light'); document.getElementById('themeToggle').textContent = 'üåô'; }

// --- Util ---
function escHtml(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// --- Init ---
buildSidebar();
loadFilings();
</script>
</body>
</html>
