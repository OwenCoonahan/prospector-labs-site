<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PPA Database — Prospector Labs</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&family=Geist+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:hsl(0 0% 3.9%);--bg-card:hsl(0 0% 5.5%);--bg-muted:hsl(0 0% 9%);
  --border:hsl(0 0% 14.9%);--ring:hsl(0 0% 83.1%);
  --fg:hsl(0 0% 98%);--fg-muted:hsl(0 0% 63.9%);--fg-dim:hsl(0 0% 45%);
  --accent:hsl(142 76% 36%);--accent-fg:hsl(0 0% 98%);
  --blue:hsl(217 91% 60%);--amber:hsl(38 92% 50%);--rose:hsl(0 84% 60%);
  --purple:hsl(280 70% 55%);--cyan:hsl(180 60% 45%);--emerald:hsl(160 84% 39%);
  --radius:0.5rem;--font:Geist,system-ui,sans-serif;--mono:'Geist Mono',monospace;
}
html.light{
  --bg:hsl(0 0% 100%);--bg-card:hsl(0 0% 98%);--bg-muted:hsl(0 0% 96.1%);
  --border:hsl(0 0% 89.8%);--ring:hsl(0 0% 3.9%);
  --fg:hsl(0 0% 3.9%);--fg-muted:hsl(0 0% 45.1%);--fg-dim:hsl(0 0% 63.9%);
}
body{font-family:var(--font);background:var(--bg);color:var(--fg);line-height:1.6;min-height:100vh}
a{color:var(--blue);text-decoration:none}a:hover{text-decoration:underline}
code,.mono{font-family:var(--mono)}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

.app{display:grid;grid-template-columns:260px 1fr;grid-template-rows:56px 1fr;height:100vh;overflow:hidden}
.header{grid-column:1/-1;display:flex;align-items:center;gap:16px;padding:0 24px;border-bottom:1px solid var(--border);background:var(--bg-card)}
.sidebar{border-right:1px solid var(--border);overflow-y:auto;padding:16px;background:var(--bg-card)}
.main{overflow-y:auto;padding:24px}

.logo{font-weight:700;font-size:15px;letter-spacing:-0.02em;display:flex;align-items:center;gap:8px}
.logo svg{color:var(--accent)}
.logo span{color:var(--fg-muted);font-weight:400;margin-left:2px}
.search-wrap{flex:1;max-width:480px;position:relative}
.search-wrap input{width:100%;background:var(--bg-muted);border:1px solid var(--border);border-radius:var(--radius);padding:8px 12px 8px 36px;color:var(--fg);font-size:14px;font-family:var(--font);outline:none;transition:border .15s}
.search-wrap input:focus{border-color:var(--accent)}
.search-wrap svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--fg-muted);width:16px;height:16px}
.header-actions{display:flex;align-items:center;gap:8px;margin-left:auto}

.btn{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:var(--radius);font-size:13px;font-weight:500;font-family:var(--font);cursor:pointer;border:1px solid var(--border);background:var(--bg-muted);color:var(--fg);transition:all .15s}
.btn:hover{background:var(--border)}
.btn-sm{padding:4px 10px;font-size:12px}
.btn-ghost{background:transparent;border-color:transparent}
.btn-ghost:hover{background:var(--bg-muted)}
.btn-accent{background:var(--accent);color:var(--accent-fg);border-color:var(--accent)}

.sidebar h3{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--fg-dim);margin:16px 0 8px;font-weight:600}
.sidebar h3:first-child{margin-top:0}
.filter-group{display:flex;flex-direction:column;gap:2px}
.filter-item{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;border-radius:calc(var(--radius) - 2px);font-size:13px;cursor:pointer;transition:background .1s;color:var(--fg-muted)}
.filter-item:hover,.filter-item.active{background:var(--bg-muted);color:var(--fg)}
.filter-item .count{font-family:var(--mono);font-size:11px;color:var(--fg-dim)}
.filter-item.active .count{color:var(--accent)}

.tabs{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:20px}
.tab{padding:8px 16px;font-size:13px;font-weight:500;color:var(--fg-muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s}
.tab:hover{color:var(--fg)}
.tab.active{color:var(--fg);border-bottom-color:var(--accent)}

.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
.stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
.stat-card .label{font-size:12px;color:var(--fg-muted);margin-bottom:4px}
.stat-card .value{font-size:28px;font-weight:700;font-family:var(--mono);letter-spacing:-0.02em}
.stat-card .sub{font-size:11px;color:var(--fg-dim);margin-top:2px}

.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.card h4{font-size:14px;font-weight:500;line-height:1.4}
.card p{font-size:13px;color:var(--fg-muted);line-height:1.5}

.chart-wrap{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px}
.chart-wrap h3{font-size:14px;font-weight:600;margin-bottom:4px}
.chart-wrap .subtitle{font-size:12px;color:var(--fg-muted);margin-bottom:16px}
.chart-container{position:relative;height:300px}
.charts-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}

.tag{display:inline-flex;align-items:center;padding:2px 8px;border-radius:9999px;font-size:11px;font-weight:500;border:1px solid var(--border);background:var(--bg-muted);color:var(--fg-muted)}
.tag-solar{border-color:hsl(38 70% 35%);color:hsl(38 92% 60%);background:hsl(38 92% 50%/.1)}
.tag-wind{border-color:hsl(217 70% 35%);color:hsl(217 91% 70%);background:hsl(217 91% 60%/.1)}
.tag-offshore{border-color:hsl(180 50% 30%);color:hsl(180 60% 55%);background:hsl(180 60% 40%/.1)}
.tag-storage{border-color:hsl(280 60% 35%);color:hsl(280 70% 65%);background:hsl(280 70% 50%/.1)}
.tag-hybrid{border-color:hsl(142 50% 30%);color:hsl(142 76% 50%);background:hsl(142 76% 36%/.1)}
.tag-active{color:hsl(142 76% 50%);background:hsl(142 76% 36%/.1);border-color:hsl(142 50% 30%)}
.tag-construction{color:hsl(38 92% 60%);background:hsl(38 92% 50%/.1);border-color:hsl(38 70% 35%)}
.tag-announced{color:hsl(217 91% 70%);background:hsl(217 91% 60%/.1);border-color:hsl(217 70% 35%)}

table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:10px 12px;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.06em;color:var(--fg-dim);border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg-card)}
td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:top}
tr:hover td{background:var(--bg-muted)}
.table-wrap{overflow-x:auto;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius)}

.leaderboard{list-style:none}
.leaderboard li{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px}
.leaderboard li:last-child{border-bottom:none}
.leaderboard .rank{font-family:var(--mono);font-size:11px;color:var(--fg-dim);width:28px}
.leaderboard .name{flex:1;font-weight:500}
.leaderboard .val{font-family:var(--mono);font-size:13px;font-weight:600;color:var(--accent)}

.heatmap-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:4px}
.heatmap-cell{padding:8px;border-radius:calc(var(--radius) - 2px);text-align:center;font-size:11px;font-weight:600;font-family:var(--mono)}
.heatmap-cell .st{display:block;font-size:13px;font-weight:700}

.tab-content{display:none}
.tab-content.active{display:block}

.detail-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;display:none;align-items:center;justify-content:center}
.detail-overlay.show{display:flex}
.detail-panel{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;max-width:700px;width:90%;max-height:80vh;overflow-y:auto}
.detail-panel h3{font-size:16px;font-weight:600;margin-bottom:16px}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.detail-field .label{font-size:11px;color:var(--fg-dim);text-transform:uppercase;letter-spacing:.06em}
.detail-field .val{font-size:14px;font-weight:500;margin-top:2px}
.close-btn{position:absolute;top:16px;right:16px;cursor:pointer;color:var(--fg-muted);font-size:18px;background:none;border:none}

.pagination{display:flex;align-items:center;justify-content:center;gap:8px;padding:16px 0}

.empty{text-align:center;padding:48px;color:var(--fg-dim);font-size:14px}
.loading{text-align:center;padding:32px;color:var(--fg-dim)}

@media(max-width:900px){
  .app{grid-template-columns:1fr;grid-template-rows:56px auto 1fr}
  .sidebar{border-right:none;border-bottom:1px solid var(--border);max-height:200px}
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .charts-row{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="app">
  <header class="header">
    <div class="logo">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
      PPA Database<span>Prospector Labs</span>
    </div>
    <div class="search-wrap">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="text" id="searchInput" placeholder="Search buyers, sellers, projects…">
    </div>
    <div class="header-actions">
      <button class="btn btn-sm" id="exportBtn">Export CSV</button>
      <button class="btn btn-sm btn-ghost" id="themeToggle" title="Toggle theme">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32 1.41 1.41M2 12h2m16 0h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/></svg>
      </button>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <h3>Technology</h3>
    <div class="filter-group" id="techFilters"></div>
    <h3>Structure</h3>
    <div class="filter-group" id="structFilters"></div>
    <h3>Status</h3>
    <div class="filter-group" id="statusFilters"></div>
    <h3>Region / ISO</h3>
    <div class="filter-group" id="regionFilters"></div>
    <h3>Buyer Type</h3>
    <div class="filter-group" id="buyerTypeFilters"></div>
  </aside>

  <main class="main" id="mainContent">
    <div class="stats-grid" id="statsGrid"></div>

    <div class="tabs" id="tabBar">
      <div class="tab active" data-tab="deals">Deal Feed</div>
      <div class="tab" data-tab="pricing">Pricing Trends</div>
      <div class="tab" data-tab="buyers">Top Buyers</div>
      <div class="tab" data-tab="sellers">Top Sellers</div>
      <div class="tab" data-tab="analysis">Market Analysis</div>
      <div class="tab" data-tab="heatmap">State Heatmap</div>
    </div>

    <div class="tab-content active" id="tab-deals">
      <div class="table-wrap"><table id="dealsTable"><thead><tr>
        <th>Buyer</th><th>Seller</th><th>Tech</th><th>MW</th><th>$/MWh</th><th>Structure</th><th>State</th><th>Term</th><th>Status</th><th>Date</th>
      </tr></thead><tbody id="dealsBody"></tbody></table></div>
      <div class="pagination" id="dealsPagination"></div>
    </div>

    <div class="tab-content" id="tab-pricing">
      <div class="chart-wrap">
        <h3>PPA Pricing Trends by Technology</h3>
        <p class="subtitle">Average contracted price ($/MWh) at time of announcement</p>
        <div class="chart-container"><canvas id="pricingChart"></canvas></div>
      </div>
      <div class="charts-row">
        <div class="chart-wrap">
          <h3>Price Range by Technology (2024–2025)</h3>
          <div class="chart-container"><canvas id="priceRangeChart"></canvas></div>
        </div>
        <div class="chart-wrap">
          <h3>Deal Volume by Year</h3>
          <div class="chart-container"><canvas id="volumeChart"></canvas></div>
        </div>
      </div>
    </div>

    <div class="tab-content" id="tab-buyers">
      <div class="charts-row">
        <div class="chart-wrap">
          <h3>Top Corporate PPA Buyers</h3>
          <p class="subtitle">Ranked by total contracted capacity (MW)</p>
          <ol class="leaderboard" id="buyersList"></ol>
        </div>
        <div class="chart-wrap">
          <h3>Buyer Capacity Distribution</h3>
          <div class="chart-container"><canvas id="buyersChart"></canvas></div>
        </div>
      </div>
    </div>

    <div class="tab-content" id="tab-sellers">
      <div class="charts-row">
        <div class="chart-wrap">
          <h3>Top Developers / Sellers</h3>
          <p class="subtitle">Ranked by total contracted capacity (MW)</p>
          <ol class="leaderboard" id="sellersList"></ol>
        </div>
        <div class="chart-wrap">
          <h3>Seller Capacity Distribution</h3>
          <div class="chart-container"><canvas id="sellersChart"></canvas></div>
        </div>
      </div>
    </div>

    <div class="tab-content" id="tab-analysis">
      <div class="charts-row">
        <div class="chart-wrap">
          <h3>Technology Breakdown</h3>
          <p class="subtitle">Contract count by generation technology</p>
          <div class="chart-container"><canvas id="techChart"></canvas></div>
        </div>
        <div class="chart-wrap">
          <h3>Deal Structure Analysis</h3>
          <p class="subtitle">Physical vs Virtual vs Sleeved PPAs</p>
          <div class="chart-container"><canvas id="structChart"></canvas></div>
        </div>
      </div>
      <div class="charts-row">
        <div class="chart-wrap">
          <h3>Capacity by Region</h3>
          <div class="chart-container"><canvas id="regionChart"></canvas></div>
        </div>
        <div class="chart-wrap">
          <h3>Annual Capacity Additions</h3>
          <div class="chart-container"><canvas id="annualCapChart"></canvas></div>
        </div>
      </div>
    </div>

    <div class="tab-content" id="tab-heatmap">
      <div class="chart-wrap">
        <h3>PPA Activity by State</h3>
        <p class="subtitle">Number of contracts and total MW by state</p>
        <div class="heatmap-grid" id="heatmapGrid"></div>
      </div>
    </div>
  </main>
</div>

<div class="detail-overlay" id="detailOverlay">
  <div class="detail-panel" id="detailPanel"></div>
</div>

<script>
const API = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
  ? 'http://localhost:8000' : 'https://api.prospectorlabs.ai';
const API_KEY = 'pk_prospector_public_demo_2025';
const H = {'X-API-Key': API_KEY};

// State
let allContracts = [], stats = {}, pricing = [], buyers = [], sellers = [];
let filters = {technology:null, structure:null, status:null, region:null, buyer_type:null};
let searchQ = '', page = 0, pageSize = 50;
let charts = {};

// Theme
const themeToggle = document.getElementById('themeToggle');
themeToggle.onclick = () => {
  document.documentElement.classList.toggle('dark');
  document.documentElement.classList.toggle('light');
  Object.values(charts).forEach(c => c && c.update());
};

// Tabs
document.querySelectorAll('.tab').forEach(t => t.onclick = () => {
  document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
  t.classList.add('active');
  document.getElementById('tab-'+t.dataset.tab).classList.add('active');
});

// Fetch
async function api(path, params={}) {
  const u = new URL(API + path);
  Object.entries(params).forEach(([k,v]) => v != null && u.searchParams.set(k, v));
  try {
    const r = await fetch(u, {headers: H});
    if (!r.ok) throw new Error(r.status);
    return await r.json();
  } catch(e) { console.warn('API err:', e); return null; }
}

// Colors
const TECH_COLORS = {'Solar':'#f59e0b','Onshore Wind':'#3b82f6','Offshore Wind':'#06b6d4','Solar + Storage':'#22c55e','Standalone Storage':'#a855f7'};
const STRUCT_COLORS = {'Virtual PPA (VPPA)':'#3b82f6','Physical PPA':'#22c55e','Sleeved PPA':'#f59e0b','Direct Bilateral':'#a855f7'};
const chartFont = {family:"Geist, system-ui, sans-serif"};
const gridColor = () => getComputedStyle(document.documentElement).getPropertyValue('--border').trim();
const fgMuted = () => getComputedStyle(document.documentElement).getPropertyValue('--fg-muted').trim();

Chart.defaults.font.family = "Geist, system-ui, sans-serif";
Chart.defaults.color = '#a1a1aa';
Chart.defaults.plugins.legend.labels.usePointStyle = true;
Chart.defaults.plugins.legend.labels.pointStyleWidth = 8;

function techTag(t) {
  const cls = t.includes('Solar + Storage')?'hybrid':t.includes('Offshore')?'offshore':t.includes('Wind')?'wind':t.includes('Storage')?'storage':'solar';
  return `<span class="tag tag-${cls}">${t}</span>`;
}
function statusTag(s) {
  const cls = s==='Active'?'active':s==='Under Construction'?'construction':'announced';
  return `<span class="tag tag-${cls}">${s}</span>`;
}

// Load everything
async function init() {
  const [statsData, pricingData, buyersData, sellersData, contractsData] = await Promise.all([
    api('/v1/ppa-tracker/stats'),
    api('/v1/ppa-tracker/pricing'),
    api('/v1/ppa-tracker/buyers'),
    api('/v1/ppa-tracker/sellers'),
    api('/v1/ppa-tracker/contracts', {limit: 500}),
  ]);

  // Fallback to demo data if API unavailable
  if (!statsData) { useDemoData(); return; }

  stats = statsData;
  pricing = pricingData || [];
  buyers = buyersData || [];
  sellers = sellersData || [];
  allContracts = contractsData?.contracts || [];

  renderStats();
  renderFilters();
  renderDeals();
  renderPricingChart();
  renderBuyers();
  renderSellers();
  renderAnalysis();
  renderHeatmap();
}

function renderStats() {
  const g = document.getElementById('statsGrid');
  g.innerHTML = `
    <div class="stat-card"><div class="label">Total Contracts</div><div class="value">${stats.total_contracts?.toLocaleString()||'—'}</div><div class="sub">Tracked PPAs</div></div>
    <div class="stat-card"><div class="label">Total Capacity</div><div class="value">${(stats.total_capacity_mw/1000).toFixed(1)} GW</div><div class="sub">${stats.total_capacity_mw?.toLocaleString()||0} MW</div></div>
    <div class="stat-card"><div class="label">Avg Price</div><div class="value">$${stats.avg_price_mwh?.toFixed(1)||'—'}</div><div class="sub">per MWh</div></div>
    <div class="stat-card"><div class="label">Technologies</div><div class="value">${Object.keys(stats.by_technology||{}).length}</div><div class="sub">Generation types</div></div>
  `;
}

function renderFilters() {
  const make = (cont, data, key) => {
    const el = document.getElementById(cont);
    el.innerHTML = Object.entries(data).map(([k,v]) =>
      `<div class="filter-item" data-key="${key}" data-val="${k}"><span>${k}</span><span class="count">${v}</span></div>`
    ).join('');
  };
  make('techFilters', stats.by_technology||{}, 'technology');
  make('structFilters', stats.by_structure||{}, 'structure');
  make('statusFilters', stats.by_status||{}, 'status');
  make('regionFilters', stats.by_region||{}, 'region');
  // buyer type from contracts
  const bt = {};
  allContracts.forEach(c => { const t = c.buyer_type || 'Unknown'; bt[t] = (bt[t]||0)+1; });
  // infer buyer_type not in brief cols, skip
  document.getElementById('buyerTypeFilters').innerHTML = `
    <div class="filter-item" data-key="buyer_type" data-val="Corporate"><span>Corporate</span></div>
    <div class="filter-item" data-key="buyer_type" data-val="Utility"><span>Utility</span></div>
  `;

  document.querySelectorAll('.filter-item').forEach(fi => fi.onclick = () => {
    const k = fi.dataset.key, v = fi.dataset.val;
    if (filters[k] === v) { filters[k] = null; fi.classList.remove('active'); }
    else {
      document.querySelectorAll(`.filter-item[data-key="${k}"]`).forEach(x => x.classList.remove('active'));
      filters[k] = v; fi.classList.add('active');
    }
    page = 0;
    loadFilteredContracts();
  });
}

async function loadFilteredContracts() {
  const params = {limit: pageSize, offset: page * pageSize};
  if (searchQ) params.q = searchQ;
  if (filters.technology) params.technology = filters.technology;
  if (filters.structure) params.structure = filters.structure;
  if (filters.status) params.status = filters.status;
  if (filters.region) params.region = filters.region;
  if (filters.buyer_type) params.buyer_type = filters.buyer_type;
  const data = await api('/v1/ppa-tracker/contracts', params);
  if (data) { allContracts = data.contracts; renderDeals(data.total); }
}

function renderDeals(total) {
  const tb = document.getElementById('dealsBody');
  const t = total || allContracts.length;
  tb.innerHTML = allContracts.map(c => `<tr class="deal-row" data-id="${c.id}" style="cursor:pointer">
    <td><strong>${esc(c.buyer)}</strong></td>
    <td>${esc(c.seller)}</td>
    <td>${techTag(c.technology)}</td>
    <td class="mono">${c.capacity_mw?.toLocaleString()}</td>
    <td class="mono">${c.price_mwh ? '$'+c.price_mwh.toFixed(2) : '—'}</td>
    <td><span class="tag">${c.structure}</span></td>
    <td>${c.state}</td>
    <td class="mono">${c.term_years}yr</td>
    <td>${statusTag(c.status)}</td>
    <td class="mono" style="font-size:12px">${c.announced_date?.slice(0,10)||''}</td>
  </tr>`).join('') || '<tr><td colspan="10" class="empty">No contracts found</td></tr>';

  // Pagination
  const pages = Math.ceil(t / pageSize);
  const pg = document.getElementById('dealsPagination');
  pg.innerHTML = `<span style="font-size:12px;color:var(--fg-dim)">${t} contracts</span>` +
    (pages > 1 ? `<button class="btn btn-sm" ${page<=0?'disabled':''} onclick="page--;loadFilteredContracts()">← Prev</button>
    <span class="mono" style="font-size:12px">${page+1} / ${pages}</span>
    <button class="btn btn-sm" ${page>=pages-1?'disabled':''} onclick="page++;loadFilteredContracts()">Next →</button>` : '');

  // Row click → detail
  document.querySelectorAll('.deal-row').forEach(r => r.onclick = () => showDetail(r.dataset.id));
}

async function showDetail(id) {
  const c = await api(`/v1/ppa-tracker/contracts/${id}`);
  if (!c) return;
  const dp = document.getElementById('detailPanel');
  dp.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px">
      <h3>${esc(c.contract_name||c.buyer+' — '+c.seller)}</h3>
      <button class="btn btn-sm btn-ghost" onclick="document.getElementById('detailOverlay').classList.remove('show')">✕</button>
    </div>
    <div class="detail-grid">
      <div class="detail-field"><div class="label">Buyer</div><div class="val">${esc(c.buyer)}</div></div>
      <div class="detail-field"><div class="label">Seller / Developer</div><div class="val">${esc(c.seller)}</div></div>
      <div class="detail-field"><div class="label">Technology</div><div class="val">${techTag(c.technology)}</div></div>
      <div class="detail-field"><div class="label">Capacity</div><div class="val mono">${c.capacity_mw?.toLocaleString()} MW</div></div>
      <div class="detail-field"><div class="label">Price</div><div class="val mono">${c.price_mwh?'$'+c.price_mwh.toFixed(2)+'/MWh':'Undisclosed'}</div></div>
      <div class="detail-field"><div class="label">Escalation</div><div class="val mono">${c.escalation_pct?c.escalation_pct+'%/yr':'Fixed'}</div></div>
      <div class="detail-field"><div class="label">Structure</div><div class="val">${c.structure}</div></div>
      <div class="detail-field"><div class="label">Settlement</div><div class="val">${c.settlement_type||'—'}</div></div>
      <div class="detail-field"><div class="label">Term</div><div class="val mono">${c.term_years} years</div></div>
      <div class="detail-field"><div class="label">COD</div><div class="val mono">${c.cod_date?.slice(0,10)||'—'}</div></div>
      <div class="detail-field"><div class="label">State</div><div class="val">${c.state_name||c.state}</div></div>
      <div class="detail-field"><div class="label">ISO/RTO</div><div class="val">${c.iso_rto||'—'}</div></div>
      <div class="detail-field"><div class="label">Est. Annual Volume</div><div class="val mono">${c.volume_annual_mwh?Math.round(c.volume_annual_mwh).toLocaleString()+' MWh':'—'}</div></div>
      <div class="detail-field"><div class="label">Hub/Node</div><div class="val">${c.hub_node||'N/A (physical)'}</div></div>
      <div class="detail-field"><div class="label">Status</div><div class="val">${statusTag(c.status)}</div></div>
      <div class="detail-field"><div class="label">Source</div><div class="val">${c.source||'—'}</div></div>
    </div>
    ${c.curtailment_provisions?`<div style="margin-top:16px"><div class="detail-field"><div class="label">Curtailment</div><div class="val" style="font-size:13px;color:var(--fg-muted)">${c.curtailment_provisions}</div></div></div>`:''}
    ${c.credit_support?`<div style="margin-top:8px"><div class="detail-field"><div class="label">Credit Support</div><div class="val" style="font-size:13px;color:var(--fg-muted)">${c.credit_support}</div></div></div>`:''}
  `;
  document.getElementById('detailOverlay').classList.add('show');
}
document.getElementById('detailOverlay').onclick = e => { if (e.target.id==='detailOverlay') e.target.classList.remove('show'); };

function renderPricingChart() {
  const years = [...new Set(pricing.map(p=>p.year))].sort();
  const techs = [...new Set(pricing.map(p=>p.technology))];
  const datasets = techs.map(t => ({
    label: t,
    data: years.map(y => { const m = pricing.find(p=>p.year===y&&p.technology===t); return m?.avg_price||null; }),
    borderColor: TECH_COLORS[t]||'#888',
    backgroundColor: (TECH_COLORS[t]||'#888')+'33',
    tension: 0.3, fill: false, pointRadius: 4, borderWidth: 2,
  }));
  charts.pricing = new Chart(document.getElementById('pricingChart'), {
    type:'line', data:{labels:years, datasets},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'}},
      scales:{y:{title:{display:true,text:'$/MWh'},grid:{color:gridColor()}},x:{grid:{color:gridColor()}}}}
  });

  // Price range (recent)
  const recent = pricing.filter(p=>p.year>=2024);
  const rt = [...new Set(recent.map(p=>p.technology))];
  charts.priceRange = new Chart(document.getElementById('priceRangeChart'), {
    type:'bar', data:{labels:rt,datasets:[
      {label:'Min',data:rt.map(t=>{const r=recent.filter(p=>p.technology===t);return r.length?Math.min(...r.map(p=>p.min_price)):0}),backgroundColor:'#22c55e44',borderColor:'#22c55e',borderWidth:1},
      {label:'Avg',data:rt.map(t=>{const r=recent.filter(p=>p.technology===t);return r.length?(r.reduce((s,p)=>s+p.avg_price,0)/r.length):0}),backgroundColor:'#3b82f644',borderColor:'#3b82f6',borderWidth:1},
      {label:'Max',data:rt.map(t=>{const r=recent.filter(p=>p.technology===t);return r.length?Math.max(...r.map(p=>p.max_price)):0}),backgroundColor:'#f59e0b44',borderColor:'#f59e0b',borderWidth:1},
    ]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'}},scales:{y:{title:{display:true,text:'$/MWh'},grid:{color:gridColor()}},x:{grid:{display:false}}}}
  });

  // Volume by year
  const byYear = stats.by_year || [];
  charts.volume = new Chart(document.getElementById('volumeChart'), {
    type:'bar', data:{labels:byYear.map(y=>y.year),datasets:[
      {label:'Contracts',data:byYear.map(y=>y.count),backgroundColor:'#3b82f6',borderRadius:4},
      {label:'GW',data:byYear.map(y=>(y.capacity_mw/1000).toFixed(1)),backgroundColor:'#22c55e',borderRadius:4,yAxisID:'y1'},
    ]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'}},
      scales:{y:{position:'left',title:{display:true,text:'Contracts'},grid:{color:gridColor()}},y1:{position:'right',title:{display:true,text:'GW'},grid:{display:false}},x:{grid:{display:false}}}}
  });
}

function renderBuyers() {
  const list = document.getElementById('buyersList');
  list.innerHTML = buyers.slice(0,15).map((b,i) =>
    `<li><span class="rank">#${i+1}</span><span class="name">${esc(b.buyer)}</span><span class="val">${b.total_capacity_mw.toLocaleString()} MW</span><span style="font-size:11px;color:var(--fg-dim);margin-left:12px;width:50px;text-align:right">${b.deal_count} deals</span></li>`
  ).join('');

  charts.buyers = new Chart(document.getElementById('buyersChart'), {
    type:'doughnut',
    data:{labels:buyers.slice(0,10).map(b=>b.buyer),datasets:[{data:buyers.slice(0,10).map(b=>b.total_capacity_mw),
      backgroundColor:['#3b82f6','#22c55e','#f59e0b','#a855f7','#06b6d4','#ef4444','#ec4899','#84cc16','#f97316','#6366f1'],borderWidth:0}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{font:{size:11}}}}}
  });
}

function renderSellers() {
  const list = document.getElementById('sellersList');
  list.innerHTML = sellers.slice(0,15).map((s,i) =>
    `<li><span class="rank">#${i+1}</span><span class="name">${esc(s.seller)}</span><span class="val">${s.total_capacity_mw.toLocaleString()} MW</span><span style="font-size:11px;color:var(--fg-dim);margin-left:12px;width:50px;text-align:right">${s.deal_count} deals</span></li>`
  ).join('');

  charts.sellers = new Chart(document.getElementById('sellersChart'), {
    type:'doughnut',
    data:{labels:sellers.slice(0,10).map(s=>s.seller),datasets:[{data:sellers.slice(0,10).map(s=>s.total_capacity_mw),
      backgroundColor:['#22c55e','#3b82f6','#f59e0b','#a855f7','#06b6d4','#ef4444','#ec4899','#84cc16','#f97316','#6366f1'],borderWidth:0}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{font:{size:11}}}}}
  });
}

function renderAnalysis() {
  // Tech breakdown
  const techData = stats.by_technology||{};
  charts.tech = new Chart(document.getElementById('techChart'), {
    type:'doughnut',
    data:{labels:Object.keys(techData),datasets:[{data:Object.values(techData),
      backgroundColor:Object.keys(techData).map(t=>TECH_COLORS[t]||'#888'),borderWidth:0}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right'}}}
  });

  // Structure
  const structData = stats.by_structure||{};
  charts.struct = new Chart(document.getElementById('structChart'), {
    type:'doughnut',
    data:{labels:Object.keys(structData),datasets:[{data:Object.values(structData),
      backgroundColor:Object.keys(structData).map(s=>STRUCT_COLORS[s]||'#888'),borderWidth:0}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right'}}}
  });

  // Region bar
  const regionData = stats.by_region||{};
  charts.region = new Chart(document.getElementById('regionChart'), {
    type:'bar',
    data:{labels:Object.keys(regionData),datasets:[{label:'Contracts',data:Object.values(regionData),backgroundColor:'#3b82f6',borderRadius:4}]},
    options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false}},scales:{x:{grid:{color:gridColor()}},y:{grid:{display:false}}}}
  });

  // Annual capacity
  const byYear = stats.by_year||[];
  charts.annualCap = new Chart(document.getElementById('annualCapChart'), {
    type:'bar',
    data:{labels:byYear.map(y=>y.year),datasets:[{label:'Capacity (MW)',data:byYear.map(y=>y.capacity_mw),backgroundColor:'#22c55e',borderRadius:4}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{title:{display:true,text:'MW'},grid:{color:gridColor()}},x:{grid:{display:false}}}}
  });
}

function renderHeatmap() {
  // Aggregate by state from contracts
  const byState = {};
  allContracts.forEach(c => {
    if (!byState[c.state]) byState[c.state] = {count:0, mw:0};
    byState[c.state].count++;
    byState[c.state].mw += c.capacity_mw||0;
  });
  const maxCount = Math.max(...Object.values(byState).map(s=>s.count), 1);
  const grid = document.getElementById('heatmapGrid');
  grid.innerHTML = Object.entries(byState).sort((a,b)=>b[1].count-a[1].count).map(([st, d]) => {
    const intensity = d.count / maxCount;
    const bg = `hsla(142, 76%, 36%, ${0.1 + intensity * 0.6})`;
    return `<div class="heatmap-cell" style="background:${bg}"><span class="st">${st}</span>${d.count} deals<br>${Math.round(d.mw).toLocaleString()} MW</div>`;
  }).join('');
}

// Search
let searchTimer;
document.getElementById('searchInput').oninput = e => {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => { searchQ = e.target.value; page = 0; loadFilteredContracts(); }, 300);
};

// Export
document.getElementById('exportBtn').onclick = () => {
  const rows = [['Buyer','Seller','Technology','MW','$/MWh','Structure','State','Term','Status','Date']];
  allContracts.forEach(c => rows.push([c.buyer,c.seller,c.technology,c.capacity_mw,c.price_mwh,c.structure,c.state,c.term_years,c.status,c.announced_date]));
  const csv = rows.map(r=>r.map(v=>`"${v||''}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ppa-database.csv'; a.click();
};

function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}

// Demo fallback data
function useDemoData() {
  const techs = ['Solar','Onshore Wind','Offshore Wind','Solar + Storage','Standalone Storage'];
  const structs = ['Virtual PPA (VPPA)','Physical PPA','Sleeved PPA','Direct Bilateral'];
  const buyerNames = ['Google','Amazon','Microsoft','Meta','Apple','Walmart','GM','Ford Motor','Target','T-Mobile'];
  const sellerNames = ['NextEra Energy Resources','AES Clean Energy','Enel Green Power','Ørsted','Invenergy','EDF Renewables','Clearway Energy','Pattern Energy','Apex Clean Energy','Avangrid Renewables'];
  const states = ['TX','CA','PA','VA','OH','MN','IA','OK','NY','NC','FL','AZ','OR','MA','IL'];
  const regions = ['ERCOT','CAISO','PJM','MISO','SPP','NYISO','ISONE','SERC','WECC','BPA'];
  const statuses = ['Active','Under Construction','Announced'];

  allContracts = [];
  for (let i=1;i<=200;i++){
    const tech=techs[Math.floor(Math.random()*techs.length)];
    const yr=2018+Math.floor(Math.random()*8);
    allContracts.push({id:i,buyer:buyerNames[Math.floor(Math.random()*buyerNames.length)],seller:sellerNames[Math.floor(Math.random()*sellerNames.length)],
      technology:tech,capacity_mw:Math.round(50+Math.random()*450),price_mwh:+(20+Math.random()*45).toFixed(2),
      structure:structs[Math.floor(Math.random()*structs.length)],term_years:[10,12,15,20][Math.floor(Math.random()*4)],
      state:states[Math.floor(Math.random()*states.length)],region:regions[Math.floor(Math.random()*regions.length)],
      status:statuses[Math.floor(Math.random()*statuses.length)],announced_date:`${yr}-${String(1+Math.floor(Math.random()*12)).padStart(2,'0')}-15`,
      iso_rto:regions[Math.floor(Math.random()*regions.length)]});
  }

  // Build stats from demo
  stats = {total_contracts:200, total_capacity_mw:allContracts.reduce((s,c)=>s+c.capacity_mw,0),
    avg_price_mwh:+(allContracts.reduce((s,c)=>s+c.price_mwh,0)/200).toFixed(2),
    by_technology:{}, by_structure:{}, by_status:{}, by_region:{}, by_year:[], top_buyers:[], top_sellers:[]};
  allContracts.forEach(c => {
    stats.by_technology[c.technology]=(stats.by_technology[c.technology]||0)+1;
    stats.by_structure[c.structure]=(stats.by_structure[c.structure]||0)+1;
    stats.by_status[c.status]=(stats.by_status[c.status]||0)+1;
    stats.by_region[c.region]=(stats.by_region[c.region]||0)+1;
  });
  const yrs = {};
  allContracts.forEach(c=>{const y=+c.announced_date.slice(0,4);if(!yrs[y])yrs[y]={year:y,count:0,capacity_mw:0,avg_price:0,prices:[]};yrs[y].count++;yrs[y].capacity_mw+=c.capacity_mw;yrs[y].prices.push(c.price_mwh)});
  stats.by_year = Object.values(yrs).sort((a,b)=>a.year-b.year).map(y=>({...y,avg_price:+(y.prices.reduce((s,p)=>s+p,0)/y.prices.length).toFixed(2)}));
  // Pricing
  pricing = [];
  techs.forEach(t=>{for(let y=2018;y<=2025;y++){const ps=allContracts.filter(c=>c.technology===t&&+c.announced_date.slice(0,4)===y);if(ps.length)pricing.push({year:y,technology:t,avg_price:+(ps.reduce((s,c)=>s+c.price_mwh,0)/ps.length).toFixed(2),min_price:Math.min(...ps.map(c=>c.price_mwh)),max_price:Math.max(...ps.map(c=>c.price_mwh)),deal_count:ps.length})}});
  // Buyers/sellers
  const bm={},sm={};
  allContracts.forEach(c=>{if(!bm[c.buyer])bm[c.buyer]={buyer:c.buyer,total_capacity_mw:0,deal_count:0};bm[c.buyer].total_capacity_mw+=c.capacity_mw;bm[c.buyer].deal_count++;
    if(!sm[c.seller])sm[c.seller]={seller:c.seller,total_capacity_mw:0,deal_count:0};sm[c.seller].total_capacity_mw+=c.capacity_mw;sm[c.seller].deal_count++});
  buyers=Object.values(bm).sort((a,b)=>b.total_capacity_mw-a.total_capacity_mw);
  sellers=Object.values(sm).sort((a,b)=>b.total_capacity_mw-a.total_capacity_mw);
  stats.top_buyers=buyers.slice(0,10).map(b=>({name:b.buyer,capacity_mw:b.total_capacity_mw}));
  stats.top_sellers=sellers.slice(0,10).map(s=>({name:s.seller,capacity_mw:s.total_capacity_mw}));

  renderStats(); renderFilters(); renderDeals(); renderPricingChart(); renderBuyers(); renderSellers(); renderAnalysis(); renderHeatmap();
}

init();
</script>
</body>
</html>
