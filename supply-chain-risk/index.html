<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Supply Chain Risk Intelligence — Prospector Labs</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&family=Geist+Mono:wght@400;500&display=swap" rel="stylesheet">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:hsl(0 0% 3.9%);--bg-card:hsl(0 0% 7%);--bg-muted:hsl(0 0% 11%);
  --border:hsl(0 0% 14.9%);--text:hsl(0 0% 98%);--text-muted:hsl(0 0% 63.9%);
  --accent:hsl(210 40% 50%);--red:hsl(0 72% 51%);--orange:hsl(25 95% 53%);
  --yellow:hsl(48 96% 53%);--green:hsl(142 71% 45%);
  --radius:8px;
}
html.light{
  --bg:hsl(0 0% 100%);--bg-card:hsl(0 0% 98%);--bg-muted:hsl(0 0% 93%);
  --border:hsl(0 0% 89.8%);--text:hsl(0 0% 3.9%);--text-muted:hsl(0 0% 45.1%);
}
body{font-family:'Geist',sans-serif;background:var(--bg);color:var(--text);line-height:1.5;font-size:14px;overflow-x:hidden}
code,.mono{font-family:'Geist Mono',monospace}
a{color:var(--accent);text-decoration:none}

/* Layout */
.header{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg);z-index:100;backdrop-filter:blur(12px)}
.header h1{font-size:16px;font-weight:600;letter-spacing:-0.02em}
.header .subtitle{color:var(--text-muted);font-size:12px;margin-left:12px}
.header-right{display:flex;align-items:center;gap:12px}
.theme-toggle{background:var(--bg-muted);border:1px solid var(--border);border-radius:var(--radius);padding:6px 10px;color:var(--text);cursor:pointer;font-size:12px;font-family:'Geist',sans-serif}

.container{max-width:1440px;margin:0 auto;padding:20px 24px}
.grid-top{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin-bottom:20px}
.grid-main{display:grid;grid-template-columns:1fr 400px;gap:20px}
.grid-bottom{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px}

/* Cards */
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;overflow:hidden}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.card-title{font-size:13px;font-weight:500;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em}
.stat-value{font-size:28px;font-weight:700;letter-spacing:-0.03em;font-family:'Geist Mono',monospace}
.stat-label{font-size:11px;color:var(--text-muted);margin-top:2px}

/* Risk badges */
.badge{display:inline-block;padding:2px 8px;border-radius:9999px;font-size:11px;font-weight:500;text-transform:uppercase;letter-spacing:0.04em}
.badge-critical{background:hsl(0 72% 51% / 0.15);color:var(--red)}
.badge-high{background:hsl(25 95% 53% / 0.15);color:var(--orange)}
.badge-moderate{background:hsl(48 96% 53% / 0.15);color:var(--yellow)}
.badge-low{background:hsl(142 71% 45% / 0.15);color:var(--green)}
.badge-warning{background:hsl(48 96% 53% / 0.15);color:var(--yellow)}
.badge-info{background:hsl(210 40% 50% / 0.15);color:var(--accent)}

/* Mineral selector */
.mineral-selector{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px}
.mineral-btn{background:var(--bg-muted);border:1px solid var(--border);border-radius:var(--radius);padding:6px 12px;color:var(--text-muted);cursor:pointer;font-size:12px;font-family:'Geist',sans-serif;transition:all 0.15s}
.mineral-btn:hover{color:var(--text);border-color:var(--text-muted)}
.mineral-btn.active{background:var(--text);color:var(--bg);border-color:var(--text)}

/* Map */
#map{width:100%;height:500px;border-radius:var(--radius)}
.mapboxgl-popup-content{background:var(--bg-card)!important;border:1px solid var(--border)!important;border-radius:var(--radius)!important;color:var(--text)!important;padding:12px!important;font-family:'Geist',sans-serif!important;font-size:13px!important;box-shadow:0 4px 12px rgba(0,0,0,0.4)!important}
.mapboxgl-popup-tip{border-top-color:var(--bg-card)!important}
.mapboxgl-ctrl-attrib{font-size:9px!important;opacity:0.5}

/* Country rankings table */
.rank-table{width:100%;border-collapse:collapse}
.rank-table th{text-align:left;padding:8px 10px;font-size:11px;font-weight:500;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.04em;border-bottom:1px solid var(--border)}
.rank-table td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:13px}
.rank-table tr{cursor:pointer;transition:background 0.1s}
.rank-table tr:hover{background:var(--bg-muted)}
.rank-table .score-bar{display:inline-block;height:6px;border-radius:3px;margin-right:8px;vertical-align:middle}
.rank-scroll{max-height:440px;overflow-y:auto}

/* Alert feed */
.alert-item{padding:10px 12px;border-bottom:1px solid var(--border);cursor:default}
.alert-item:last-child{border-bottom:none}
.alert-date{font-size:11px;color:var(--text-muted);font-family:'Geist Mono',monospace}
.alert-title{font-size:13px;font-weight:500;margin:4px 0 2px}
.alert-desc{font-size:12px;color:var(--text-muted);line-height:1.4}
.alert-scroll{max-height:350px;overflow-y:auto}

/* Charts */
canvas{max-width:100%;max-height:300px}

/* Radar container */
.radar-header{display:flex;align-items:center;justify-content:space-between}
.radar-pair{font-family:'Geist Mono',monospace;font-size:13px;color:var(--text-muted)}

/* Responsive */
@media(max-width:1200px){.grid-main{grid-template-columns:1fr}}
@media(max-width:900px){.grid-top{grid-template-columns:1fr 1fr}.grid-bottom{grid-template-columns:1fr}}
@media(max-width:600px){.grid-top{grid-template-columns:1fr}.mineral-selector{gap:4px}}

/* Scrollbar */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
</style>
</head>
<body>

<div class="header">
  <div style="display:flex;align-items:baseline">
    <h1>Supply Chain Risk Intelligence</h1>
    <span class="subtitle">Prospector Labs</span>
  </div>
  <div class="header-right">
    <span class="mono" style="font-size:11px;color:var(--text-muted)" id="updateTime"></span>
    <button class="theme-toggle" onclick="toggleTheme()">◑ Theme</button>
  </div>
</div>

<div class="container">
  <!-- Stats row -->
  <div class="grid-top" id="statsRow">
    <div class="card"><div class="card-title">Global Risk Index</div><div class="stat-value" id="statAvgRisk">—</div><div class="stat-label">weighted average</div></div>
    <div class="card"><div class="card-title">Highest Risk</div><div class="stat-value" id="statHighest">—</div><div class="stat-label" id="statHighestLabel">—</div></div>
    <div class="card"><div class="card-title">Most Concentrated</div><div class="stat-value" id="statConc">—</div><div class="stat-label" id="statConcLabel">HHI index</div></div>
    <div class="card"><div class="card-title">Critical Alerts</div><div class="stat-value" id="statAlerts">—</div><div class="stat-label">last 90 days</div></div>
  </div>

  <!-- Mineral selector -->
  <div class="mineral-selector" id="mineralSelector"></div>

  <!-- Main grid: map + sidebar -->
  <div class="grid-main">
    <div class="card" style="padding:0;overflow:hidden">
      <div id="map"></div>
    </div>
    <div>
      <div class="card" style="margin-bottom:16px">
        <div class="card-header">
          <span class="card-title">Country Rankings</span>
          <span class="mono" style="font-size:11px;color:var(--text-muted)" id="mineralLabel">—</span>
        </div>
        <div class="rank-scroll" id="rankTable"></div>
      </div>
      <div class="card">
        <div class="card-header radar-header">
          <span class="card-title">Risk Breakdown</span>
          <span class="radar-pair" id="radarPair">select a country</span>
        </div>
        <canvas id="radarChart" height="220"></canvas>
      </div>
    </div>
  </div>

  <!-- Bottom grid -->
  <div class="grid-bottom">
    <div class="card">
      <div class="card-header">
        <span class="card-title">Production Concentration</span>
      </div>
      <canvas id="concChart" height="260"></canvas>
    </div>
    <div class="card">
      <div class="card-header">
        <span class="card-title">Risk Alerts</span>
      </div>
      <div class="alert-scroll" id="alertFeed"></div>
    </div>
  </div>

  <!-- HHI chart -->
  <div style="margin-top:20px">
    <div class="card">
      <div class="card-header">
        <span class="card-title">HHI Concentration Index by Mineral</span>
        <span style="font-size:11px;color:var(--text-muted)">Higher = more concentrated supply</span>
      </div>
      <canvas id="hhiChart" height="100"></canvas>
    </div>
  </div>
</div>

<script>
const API_BASE = 'https://prospector-api.fly.dev';
const API_KEY = ''; // set if needed
const MAPBOX_TOKEN = 'MAPBOX_TOKEN_PLACEHOLDER';

const MINERALS = ['lithium','cobalt','nickel','copper','rare_earths','graphite','manganese','platinum','vanadium','silicon'];
const MINERAL_LABELS = {lithium:'Lithium',cobalt:'Cobalt',nickel:'Nickel',copper:'Copper',rare_earths:'Rare Earths',graphite:'Graphite',manganese:'Manganese',platinum:'Platinum',vanadium:'Vanadium',silicon:'Silicon'};

// ISO2 → ISO3 for map choropleth
const ISO2_TO_3={AF:"AFG",AL:"ALB",DZ:"DZA",AR:"ARG",AU:"AUS",AT:"AUT",BD:"BGD",BE:"BEL",BO:"BOL",BR:"BRA",BG:"BGR",KH:"KHM",CM:"CMR",CA:"CAN",CL:"CHL",CN:"CHN",CO:"COL",CD:"COD",CR:"CRI",CI:"CIV",HR:"HRV",CU:"CUB",CZ:"CZE",DK:"DNK",DO:"DOM",EC:"ECU",EG:"EGY",SV:"SLV",ET:"ETH",FI:"FIN",FR:"FRA",GA:"GAB",DE:"DEU",GH:"GHA",GR:"GRC",GT:"GTM",HN:"HND",HK:"HKG",HU:"HUN",IS:"ISL",IN:"IND",ID:"IDN",IR:"IRN",IQ:"IRQ",IE:"IRL",IL:"ISR",IT:"ITA",JP:"JPN",JO:"JOR",KZ:"KAZ",KE:"KEN",KR:"KOR",KW:"KWT",LA:"LAO",LB:"LBN",LY:"LBY",LT:"LTU",LU:"LUX",MG:"MDG",MY:"MYS",ML:"MLI",MX:"MEX",MA:"MAR",MZ:"MOZ",MM:"MMR",NP:"NPL",NL:"NLD",NZ:"NZL",NI:"NIC",NE:"NER",NG:"NGA",NO:"NOR",OM:"OMN",PK:"PAK",PA:"PAN",PG:"PNG",PY:"PRY",PE:"PER",PH:"PHL",PL:"POL",PT:"PRT",QA:"QAT",RO:"ROU",RU:"RUS",SA:"SAU",SN:"SEN",RS:"SRB",SG:"SGP",SK:"SVK",SI:"SVN",ZA:"ZAF",ES:"ESP",LK:"LKA",SD:"SDN",SE:"SWE",CH:"CHE",SY:"SYR",TW:"TWN",TZ:"TZA",TH:"THA",TN:"TUN",TR:"TUR",UA:"UKR",AE:"ARE",GB:"GBR",US:"USA",UY:"URY",UZ:"UZB",VE:"VEN",VN:"VNM",YE:"YEM",ZM:"ZMB",ZW:"ZWE",NC:"NCL"};

let selectedMineral = 'lithium';
let mineralData = {};
let concData = [];
let map, radarChart, concChart, hhiChart;

// ── Theme ──
function toggleTheme(){
  document.documentElement.classList.toggle('dark');
  document.documentElement.classList.toggle('light');
  updateChartColors();
}

function isDark(){return document.documentElement.classList.contains('dark')}
function chartText(){return isDark()?'rgba(255,255,255,0.7)':'rgba(0,0,0,0.6)'}
function chartGrid(){return isDark()?'rgba(255,255,255,0.08)':'rgba(0,0,0,0.08)'}

// ── Color helpers ──
function riskColor(score){
  if(score>=70)return'#ef4444';if(score>=50)return'#f97316';if(score>=30)return'#eab308';return'#22c55e';
}
function badgeClass(level){return'badge badge-'+(level||'low')}

// ── Fetch helper (works with or without API) ──
// Embedded data fallback since API may require auth
let USE_EMBEDDED = true;

// We'll fetch from API first, fall back to embedded
async function apiFetch(path){
  if(USE_EMBEDDED) return null;
  try{
    const h = API_KEY ? {'X-API-Key':API_KEY} : {};
    const r = await fetch(API_BASE+path,{headers:h});
    if(!r.ok) throw new Error(r.status);
    return await r.json();
  }catch(e){return null;}
}

// ── EMBEDDED DATA (from seed) ──
const EMBEDDED_PRODUCTION = {"lithium":{"AU":47,"CL":30,"CN":15,"AR":5,"BR":1.5,"US":0.5,"ZW":0.5,"CA":0.5},"cobalt":{"CD":73,"ID":5,"RU":4.5,"AU":3,"PH":3.5,"CU":2.5,"CA":2.5,"CN":2,"MZ":1.5,"PG":1,"ZA":1.5},"nickel":{"ID":49,"PH":10.5,"RU":7,"NC":6,"AU":5.5,"CN":4.5,"CA":4,"BR":3.5,"PG":2.5,"US":0.5,"ZA":1,"FI":1.5,"NO":1,"IN":1.5,"TR":1,"GH":1},"copper":{"CL":24,"PE":10.5,"CD":10,"CN":8.5,"US":5.5,"ID":5,"AU":4,"RU":4,"ZA":3,"MX":3.5,"KZ":3.5,"PL":3,"CA":2.5,"BR":2,"AR":1.5,"PH":1,"IN":1.5,"SE":1,"TR":1,"FI":1,"ZW":0.5,"PG":0.5,"TZ":0.5,"MZ":0.5},"rare_earths":{"CN":70,"MM":9,"AU":6,"US":4.5,"IN":3,"TZ":2,"RU":2,"BR":1,"CA":1,"ZA":0.5,"SE":0.5,"MA":0.5},"graphite":{"CN":65,"MZ":8,"BR":7,"IN":4,"KR":2,"NO":2,"CA":2,"TR":2,"TZ":2,"ZW":1,"US":0.5,"AU":1,"DE":0.5},"manganese":{"ZA":37,"GA":14,"AU":13,"GH":7,"CN":6.5,"IN":5.5,"BR":5,"MM":3,"MX":2,"KZ":2,"MA":1.5,"TR":1.5},"platinum":{"ZA":72,"RU":11,"ZW":8,"CA":3.5,"US":3,"CN":1,"FI":0.5,"AU":1},"vanadium":{"CN":67,"RU":14,"ZA":9,"BR":6,"US":2,"AU":1,"IN":1},"silicon":{"CN":69,"RU":6,"BR":5.5,"NO":4.5,"US":4,"IN":2,"AU":2,"ZA":1.5,"CA":1.5,"DE":1.5}};

const COUNTRIES_META = {"CN":["China",-0.45,true],"AU":["Australia",1.55,false],"CL":["Chile",0.65,false],"CD":["DR Congo",-1.85,false],"ID":["Indonesia",-0.15,true],"RU":["Russia",-0.95,true],"ZA":["South Africa",-0.05,false],"PH":["Philippines",-0.30,false],"BR":["Brazil",-0.15,false],"CA":["Canada",1.50,false],"US":["United States",0.95,false],"AR":["Argentina",-0.20,true],"MX":["Mexico",-0.45,false],"PE":["Peru",-0.35,false],"MM":["Myanmar",-1.60,true],"CU":["Cuba",-0.55,true],"IN":["India",-0.25,true],"JP":["Japan",1.35,false],"KR":["South Korea",0.85,false],"DE":["Germany",1.30,false],"FI":["Finland",1.70,false],"NO":["Norway",1.65,false],"SE":["Sweden",1.55,false],"PL":["Poland",0.65,false],"TR":["Turkey",-0.65,true],"MA":["Morocco",-0.30,false],"GA":["Gabon",-0.55,false],"GH":["Ghana",0.05,false],"ZW":["Zimbabwe",-1.20,true],"NC":["New Caledonia",1.10,false],"PG":["Papua New Guinea",-0.60,false],"TZ":["Tanzania",-0.35,false],"MZ":["Mozambique",-0.90,false],"KZ":["Kazakhstan",-0.50,true],"UZ":["Uzbekistan",-0.80,true]};

const SUBSTITUTION = {lithium:75,cobalt:55,nickel:50,copper:40,rare_earths:90,graphite:60,manganese:45,platinum:65,vanadium:70,silicon:35};

const EMBEDDED_ALERTS = [
  {id:1,date:"2026-02-15",mineral:"rare_earths",country:"China",country_iso:"CN",severity:"critical",title:"China Expands Rare Earth Export Controls",description:"New export licensing for samarium, gadolinium, terbium. ~70% of global supply affected."},
  {id:2,date:"2026-02-12",mineral:"cobalt",country:"DR Congo",country_iso:"CD",severity:"critical",title:"DRC Mining Code Raises Royalties to 10%",description:"Cobalt royalty rates increased from 3.5% to 10%, effective Q2 2026."},
  {id:3,date:"2026-02-10",mineral:"lithium",country:null,country_iso:null,severity:"warning",title:"Lithium Prices Below Production Cost",description:"Spot at $9,200/t — below marginal cost for Australian spodumene operations."},
  {id:4,date:"2026-02-08",mineral:"nickel",country:"Indonesia",country_iso:"ID",severity:"warning",title:"Indonesia Signals Nickel Export Tax Hike",description:"Draft regulation to raise processed nickel levy from 2% to 7.5%."},
  {id:5,date:"2026-01-28",mineral:"graphite",country:"China",country_iso:"CN",severity:"critical",title:"China Graphite Export Permits Denied",description:"Multiple export permit applications denied since Dec 2025 controls."},
  {id:6,date:"2026-01-20",mineral:"platinum",country:"South Africa",country_iso:"ZA",severity:"warning",title:"Load-Shedding Disrupts PGM Smelters",description:"Stage 4 load-shedding affecting Anglo American and Impala Platinum."},
  {id:7,date:"2026-01-15",mineral:"copper",country:null,country_iso:null,severity:"info",title:"Global Copper Deficit Widens to 500kt",description:"ICSG forecasts 2026 refined copper deficit of 500,000 tonnes."},
  {id:8,date:"2026-01-10",mineral:"vanadium",country:"China",country_iso:"CN",severity:"warning",title:"China Vanadium Output Cuts",description:"Sichuan province mandating 15% production cuts at vanadium smelters."},
  {id:9,date:"2026-01-05",mineral:"manganese",country:"Gabon",country_iso:"GA",severity:"warning",title:"Gabon Rail Delays Hit Manganese Shipments",description:"Trans-Gabon railway closures to reduce Q1 shipments ~20%."},
  {id:10,date:"2026-01-02",mineral:"silicon",country:"Russia",country_iso:"RU",severity:"info",title:"EU Sanctions Include Russian Silicon Metal",description:"14th EU sanctions package adds Russian silicon to restricted imports."},
  {id:11,date:"2025-12-20",mineral:"rare_earths",country:"Myanmar",country_iso:"MM",severity:"critical",title:"Myanmar RE Mining Halted by Conflict",description:"Kachin State operations suspended due to renewed armed conflict."},
  {id:12,date:"2025-12-15",mineral:"nickel",country:"New Caledonia",country_iso:"NC",severity:"warning",title:"New Caledonia Protests Halt Nickel Exports",description:"Pro-independence protests and port blockades halt ore shipments."},
];

// ── Scoring functions (mirror backend) ──
function wgiToRisk(wgi){return Math.max(0,Math.min(100,((-wgi+2.5)/5)*100))}
function calcHHI(shares){return Object.values(shares).reduce((s,v)=>s+v*v,0)}

function calcLogistics(iso){
  const chokepoints = new Set(["CD","MM","CU","RU","TR","GA","ZW","NC","PG","TZ","MZ","KZ","UZ"]);
  const remote = new Set(["NC","PG","MZ","TZ","GA","MM","UZ","KZ","ZW"]);
  const moderate = new Set(["ZA","CD","PH","ID","AU","IN","BR","RU","TR","GH","MA"]);
  if(chokepoints.has(iso))return 70;
  if(remote.has(iso))return 55;
  if(moderate.has(iso))return 40;
  return 20;
}

function calcExportRisk(mineral,iso){
  const c=COUNTRIES_META[iso];if(!c)return 10;
  let base=c[2]?80:10;
  const share=(EMBEDDED_PRODUCTION[mineral]||{})[iso]||0;
  if(c[2]&&share>30)base=Math.min(100,base+15);
  return base;
}

function calcConcentrationRisk(mineral){
  const shares=EMBEDDED_PRODUCTION[mineral]||{};
  return Math.min(100,(calcHHI(shares)/10000)*100*1.5);
}

function computeScore(mineral,iso){
  const c=COUNTRIES_META[iso]||["Unknown",0,false];
  const shares=EMBEDDED_PRODUCTION[mineral]||{};
  const share=shares[iso]||0;
  const concentration=calcConcentrationRisk(mineral);
  const political=wgiToRisk(c[1]);
  const exportR=calcExportRisk(mineral,iso);
  const substitution=SUBSTITUTION[mineral]||50;
  const logistics=calcLogistics(iso);
  const composite=concentration*0.30+political*0.25+exportR*0.20+substitution*0.15+logistics*0.10;
  const level=composite<30?'low':composite<50?'moderate':composite<70?'high':'critical';
  return{mineral,country:c[0],country_iso:iso,composite_score:Math.round(composite*10)/10,risk_level:level,
    concentration_risk:Math.round(concentration*10)/10,political_risk:Math.round(political*10)/10,
    export_restriction_risk:Math.round(exportR*10)/10,substitution_risk:Math.round(substitution*10)/10,
    logistics_risk:Math.round(logistics*10)/10,production_share_pct:share};
}

function getMineralData(mineral){
  const shares=EMBEDDED_PRODUCTION[mineral]||{};
  const countries=Object.keys(shares).map(iso=>computeScore(mineral,iso)).sort((a,b)=>b.composite_score-a.composite_score);
  const hhi=calcHHI(shares);
  const top=countries.reduce((a,b)=>(b.production_share_pct>a.production_share_pct?b:a),countries[0]);
  return{mineral,countries,hhi:Math.round(hhi),avg_risk:Math.round(countries.reduce((s,c)=>s+c.composite_score,0)/countries.length*10)/10,
    max_risk:Math.max(...countries.map(c=>c.composite_score)),top_producer:top?.country||'',top_producer_share_pct:top?.production_share_pct||0};
}

// ── Init ──
document.addEventListener('DOMContentLoaded',init);

async function init(){
  document.getElementById('updateTime').textContent='Updated: 2026-02-20';
  buildMineralSelector();
  initMap();
  loadStats();
  loadAlerts();
  selectMineral('lithium');
  buildHHIChart();
}

function buildMineralSelector(){
  const el=document.getElementById('mineralSelector');
  MINERALS.forEach(m=>{
    const btn=document.createElement('button');
    btn.className='mineral-btn'+(m===selectedMineral?' active':'');
    btn.textContent=MINERAL_LABELS[m];
    btn.onclick=()=>selectMineral(m);
    el.appendChild(btn);
  });
}

function selectMineral(m){
  selectedMineral=m;
  document.querySelectorAll('.mineral-btn').forEach(b=>b.classList.toggle('active',b.textContent===MINERAL_LABELS[m]));
  document.getElementById('mineralLabel').textContent=MINERAL_LABELS[m];
  mineralData=getMineralData(m);
  updateMap();
  updateRankings();
  updateConcentrationChart();
  // Select top producer for radar
  if(mineralData.countries.length)selectCountryForRadar(mineralData.countries[0]);
}

// ── Map ──
function initMap(){
  mapboxgl.accessToken=MAPBOX_TOKEN;
  map=new mapboxgl.Map({
    container:'map',style:isDark()?'mapbox://styles/mapbox/dark-v11':'mapbox://styles/mapbox/light-v11',
    center:[20,20],zoom:1.5,projection:'mercator',
    attributionControl:false
  });
  map.addControl(new mapboxgl.NavigationControl(),'top-left');
  map.on('load',()=>{
    map.addSource('countries',{type:'vector',url:'mapbox://mapbox.country-boundaries-v1'});
    map.addLayer({
      id:'risk-fill',type:'fill',source:'countries','source-layer':'country_boundaries',
      paint:{'fill-color':'transparent','fill-opacity':0.7}
    },'admin-0-boundary');
    map.addLayer({
      id:'risk-outline',type:'line',source:'countries','source-layer':'country_boundaries',
      paint:{'line-color':isDark()?'rgba(255,255,255,0.1)':'rgba(0,0,0,0.1)','line-width':0.5}
    });
    map.on('click','risk-fill',onMapClick);
    map.on('mouseenter','risk-fill',()=>map.getCanvas().style.cursor='pointer');
    map.on('mouseleave','risk-fill',()=>map.getCanvas().style.cursor='');
    updateMap();
  });
}

function updateMap(){
  if(!map||!map.getLayer('risk-fill'))return;
  const colorStops=['match',['get','iso_3166_1']];
  mineralData.countries.forEach(c=>{
    const iso3=ISO2_TO_3[c.country_iso];
    if(iso3){colorStops.push(iso3,riskColor(c.composite_score));}
  });
  colorStops.push('transparent');
  map.setPaintProperty('risk-fill','fill-color',colorStops);
}

function onMapClick(e){
  const iso3=e.features[0]?.properties?.iso_3166_1;
  if(!iso3)return;
  const iso2=Object.keys(ISO2_TO_3).find(k=>ISO2_TO_3[k]===iso3);
  if(!iso2)return;
  const score=mineralData.countries.find(c=>c.country_iso===iso2);
  if(!score)return;
  selectCountryForRadar(score);
  new mapboxgl.Popup({closeButton:true,maxWidth:'280px'})
    .setLngLat(e.lngLat)
    .setHTML(`<div style="font-family:Geist,sans-serif">
      <div style="font-weight:600;margin-bottom:6px">${score.country}</div>
      <div style="display:flex;justify-content:space-between;margin-bottom:4px">
        <span style="color:${isDark()?'rgba(255,255,255,0.6)':'rgba(0,0,0,0.5)'}">Risk Score</span>
        <span class="mono" style="font-weight:600;color:${riskColor(score.composite_score)}">${score.composite_score}</span>
      </div>
      <div style="display:flex;justify-content:space-between;margin-bottom:4px">
        <span style="color:${isDark()?'rgba(255,255,255,0.6)':'rgba(0,0,0,0.5)'}">Production Share</span>
        <span class="mono">${score.production_share_pct}%</span>
      </div>
      <span class="${badgeClass(score.risk_level)}">${score.risk_level}</span>
    </div>`)
    .addTo(map);
}

// ── Rankings table ──
function updateRankings(){
  const el=document.getElementById('rankTable');
  let html=`<table class="rank-table"><thead><tr><th>#</th><th>Country</th><th>Risk</th><th>Share</th><th>Level</th></tr></thead><tbody>`;
  mineralData.countries.forEach((c,i)=>{
    html+=`<tr onclick="selectCountryForRadar(mineralData.countries[${i}])">
      <td class="mono" style="color:var(--text-muted)">${i+1}</td>
      <td><span style="font-weight:500">${c.country}</span> <span class="mono" style="color:var(--text-muted);font-size:11px">${c.country_iso}</span></td>
      <td><span class="score-bar" style="width:${c.composite_score*0.6}px;background:${riskColor(c.composite_score)}"></span><span class="mono" style="font-weight:500">${c.composite_score}</span></td>
      <td class="mono">${c.production_share_pct}%</td>
      <td><span class="${badgeClass(c.risk_level)}">${c.risk_level}</span></td>
    </tr>`;
  });
  html+=`</tbody></table>`;
  el.innerHTML=html;
}

// ── Radar chart ──
function selectCountryForRadar(score){
  document.getElementById('radarPair').textContent=`${MINERAL_LABELS[score.mineral]} × ${score.country}`;
  const dims=[score.concentration_risk,score.political_risk,score.export_restriction_risk,score.substitution_risk,score.logistics_risk];
  const labels=['Concentration','Political','Export\nRestriction','Substitution','Logistics'];
  if(radarChart)radarChart.destroy();
  radarChart=new Chart(document.getElementById('radarChart'),{
    type:'radar',
    data:{labels,datasets:[{
      data:dims,backgroundColor:'rgba(59,130,246,0.15)',borderColor:'rgb(59,130,246)',borderWidth:2,pointRadius:4,pointBackgroundColor:'rgb(59,130,246)'
    }]},
    options:{
      responsive:true,maintainAspectRatio:false,
      scales:{r:{min:0,max:100,ticks:{stepSize:25,color:chartText(),backdropColor:'transparent',font:{size:10}},grid:{color:chartGrid()},pointLabels:{color:chartText(),font:{size:11,family:'Geist'}}}},
      plugins:{legend:{display:false}}
    }
  });
}

// ── Concentration donut ──
function updateConcentrationChart(){
  const shares=EMBEDDED_PRODUCTION[selectedMineral]||{};
  const sorted=Object.entries(shares).sort((a,b)=>b[1]-a[1]);
  const labels=sorted.map(([iso])=>(COUNTRIES_META[iso]||[iso])[0]);
  const data=sorted.map(([,v])=>v);
  const colors=sorted.map(([iso])=>{const s=computeScore(selectedMineral,iso);return riskColor(s.composite_score)});
  if(concChart)concChart.destroy();
  concChart=new Chart(document.getElementById('concChart'),{
    type:'doughnut',
    data:{labels,datasets:[{data,backgroundColor:colors,borderColor:isDark()?'hsl(0,0%,7%)':'hsl(0,0%,98%)',borderWidth:2}]},
    options:{
      responsive:true,maintainAspectRatio:false,cutout:'55%',
      plugins:{
        legend:{position:'right',labels:{color:chartText(),font:{size:11,family:'Geist'},padding:6,usePointStyle:true,pointStyle:'circle'}},
        tooltip:{callbacks:{label:ctx=>`${ctx.label}: ${ctx.parsed}%`}}
      }
    }
  });
}

// ── HHI bar chart ──
function buildHHIChart(){
  const data=MINERALS.map(m=>({mineral:m,hhi:Math.round(calcHHI(EMBEDDED_PRODUCTION[m]||{}))})).sort((a,b)=>b.hhi-a.hhi);
  if(hhiChart)hhiChart.destroy();
  hhiChart=new Chart(document.getElementById('hhiChart'),{
    type:'bar',
    data:{
      labels:data.map(d=>MINERAL_LABELS[d.mineral]),
      datasets:[{
        data:data.map(d=>d.hhi),
        backgroundColor:data.map(d=>d.hhi>5000?'rgba(239,68,68,0.6)':d.hhi>2500?'rgba(249,115,22,0.6)':d.hhi>1500?'rgba(234,179,8,0.6)':'rgba(34,197,94,0.6)'),
        borderColor:data.map(d=>d.hhi>5000?'rgb(239,68,68)':d.hhi>2500?'rgb(249,115,22)':d.hhi>1500?'rgb(234,179,8)':'rgb(34,197,94)'),
        borderWidth:1,borderRadius:4
      }]
    },
    options:{
      responsive:true,maintainAspectRatio:false,indexAxis:'y',
      scales:{
        x:{grid:{color:chartGrid()},ticks:{color:chartText(),font:{family:'Geist Mono',size:11}},
          title:{display:true,text:'HHI (0-10,000)',color:chartText(),font:{family:'Geist',size:11}}},
        y:{grid:{display:false},ticks:{color:chartText(),font:{family:'Geist',size:12}}}
      },
      plugins:{
        legend:{display:false},
        tooltip:{callbacks:{label:ctx=>`HHI: ${ctx.parsed.x.toLocaleString()}`}}
      }
    }
  });
}

// ── Stats ──
function loadStats(){
  const allScores=MINERALS.flatMap(m=>Object.keys(EMBEDDED_PRODUCTION[m]).map(iso=>computeScore(m,iso)));
  const avg=allScores.reduce((s,c)=>s+c.composite_score,0)/allScores.length;
  const highest=allScores.reduce((a,b)=>b.composite_score>a.composite_score?b:a);
  const hhis=MINERALS.map(m=>({m,hhi:calcHHI(EMBEDDED_PRODUCTION[m]||{})})).sort((a,b)=>b.hhi-a.hhi);
  const critAlerts=EMBEDDED_ALERTS.filter(a=>a.severity==='critical').length;

  document.getElementById('statAvgRisk').textContent=Math.round(avg*10)/10;
  document.getElementById('statHighest').textContent=highest.composite_score;
  document.getElementById('statHighestLabel').textContent=`${MINERAL_LABELS[highest.mineral]} × ${highest.country}`;
  document.getElementById('statConc').textContent=Math.round(hhis[0].hhi).toLocaleString();
  document.getElementById('statConcLabel').textContent=`${MINERAL_LABELS[hhis[0].m]} HHI`;
  document.getElementById('statAlerts').textContent=critAlerts;
}

// ── Alerts ──
function loadAlerts(){
  const el=document.getElementById('alertFeed');
  el.innerHTML=EMBEDDED_ALERTS.map(a=>`
    <div class="alert-item">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span class="alert-date">${a.date}</span>
        <span class="${badgeClass(a.severity)}">${a.severity}</span>
      </div>
      <div class="alert-title">${a.title}</div>
      <div class="alert-desc">${a.description}</div>
    </div>
  `).join('');
}

// ── Chart color updates on theme toggle ──
function updateChartColors(){
  if(map){
    map.setStyle(isDark()?'mapbox://styles/mapbox/dark-v11':'mapbox://styles/mapbox/light-v11');
    map.once('style.load',()=>{
      map.addSource('countries',{type:'vector',url:'mapbox://mapbox.country-boundaries-v1'});
      map.addLayer({id:'risk-fill',type:'fill',source:'countries','source-layer':'country_boundaries',paint:{'fill-color':'transparent','fill-opacity':0.7}},'admin-0-boundary');
      map.addLayer({id:'risk-outline',type:'line',source:'countries','source-layer':'country_boundaries',paint:{'line-color':isDark()?'rgba(255,255,255,0.1)':'rgba(0,0,0,0.1)','line-width':0.5}});
      updateMap();
    });
  }
  selectMineral(selectedMineral);
  buildHHIChart();
}
</script>
</body>
</html>
